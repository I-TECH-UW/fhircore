"use strict";(self.webpackChunkfhircore=self.webpackChunkfhircore||[]).push([[987],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>m});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},c=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),c=p(n),m=a,g=c["".concat(s,".").concat(m)]||c[m]||u[m]||i;return n?r.createElement(g,o(o({ref:t},d),{},{components:n})):r.createElement(g,o({ref:t},d))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var p=2;p<i;p++)o[p]=n[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}c.displayName="MDXCreateElement"},1099:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var r=n(7462),a=(n(7294),n(3905));const i={},o="Resource closure using configured questionnaires",l={unversionedId:"engineering-android-app/Configurations/event-management/resource-closure",id:"engineering-android-app/Configurations/event-management/resource-closure",title:"Resource closure using configured questionnaires",description:"Event management implementation provides the ability to configure a questionnaire so that we can state which resources to close when it is submitted.",source:"@site/docs/engineering-android-app/Configurations/event-management/resource-closure.mdx",sourceDirName:"engineering-android-app/Configurations/event-management",slug:"/engineering-android-app/Configurations/event-management/resource-closure",permalink:"/engineering-android-app/Configurations/event-management/resource-closure",draft:!1,editUrl:"https://github.com/opensrp/fhircore/tree/main/docs/docs/engineering-android-app/Configurations/event-management/resource-closure.mdx",tags:[],version:"current",frontMatter:{},sidebar:"defaultSidebar",previous:{title:"Refresh/Invalidate cache",permalink:"/engineering-android-app/Configurations/event-management/refresh-cache"},next:{title:"Geowidget",permalink:"/engineering-android-app/Configurations/geowidget-config"}},s={},p=[{value:"Sample event workflow configuration",id:"sample-event-workflow-configuration",level:2},{value:"EventWorkflows properties",id:"eventworkflows-properties",level:2},{value:"Trigger condition properties",id:"trigger-condition-properties",level:3},{value:"Event Resource Properties",id:"event-resource-properties",level:3},{value:"DataQuery properties",id:"dataquery-properties",level:3}],d={toc:p};function u(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"resource-closure-using-configured-questionnaires"},"Resource closure using configured questionnaires"),(0,a.kt)("p",null,"Event management implementation provides the ability to configure a questionnaire so that we can state which resources to close when it is submitted."),(0,a.kt)("p",null,"Some use cases would be -"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Closing CarePlans and Tasks for a patient/family when they are removed."),(0,a.kt)("li",{parentName:"ul"},"Closing child-related CarePlans and Tasks if a patient's age is updated to more than 5 years."),(0,a.kt)("li",{parentName:"ul"},"Closing ANC CarePlan and Tasks when a pregnancy outcome form is submitted.")),(0,a.kt)("p",null,"This is achieved by use of the ",(0,a.kt)("inlineCode",{parentName:"p"},"EventWorkFlow")," config."),(0,a.kt)("h2",{id:"sample-event-workflow-configuration"},"Sample event workflow configuration"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'\n{\n "eventWorkflows": [\n              {\n                "eventType": "RESOURCE_CLOSURE",\n                "triggerConditions": [\n                  {\n                    "eventResourceId": "carePlanToBeClosed",\n                    "matchAll": false,\n                    "conditionalFhirPathExpressions": [\n                      "condition-to-check"\n                    ]\n                  }\n                ],\n                "eventResources": [\n                  {\n                    "id": "carePlanToBeClosed",\n                    "resource": "CarePlan",\n                    "configRules": [\n                      {\n                        "name": "patientId",\n                        "condition": "true",\n                        "actions": [\n                          "data.put(\'patientId\', fhirPath.extractValue(Patient, \'Patient.id\'))"\n                        ]\n                      }\n                    ],\n                    "dataQueries": [\n                      {\n                        "paramName": "instantiates-canonical",\n                        "filterCriteria": [\n                          {\n                            "dataType": "REFERENCE",\n                            "value": "PlanDefinition/planDefinition-uuid-used-to-generate-the-resources"\n                          }\n                        ]\n                      },\n                      {\n                        "paramName": "subject",\n                        "filterCriteria": [\n                          {\n                            "dataType": "REFERENCE",\n                            "computedRule": "patientId"\n                          }\n                        ]\n                      }\n                    ],\n                    "relatedResources": [\n                      {\n                        "resource": "Task",\n                        "searchParameter": "based-on"\n                      }\n                    ]\n                  }\n                ]\n              }\n            ]\n}\n\n')),(0,a.kt)("p",null,"The current implementation eventWorkflow config only handle closure of resources, hence the event type defaults to ",(0,a.kt)("inlineCode",{parentName:"p"},"RESOURCE_CLOSURE"),". This implementation can be expanded in future to handle other types of events."),(0,a.kt)("p",null,"The trigger conditions determine whether to close resources depending on the the result of evaluating the fhirpath expressions.\nThe fhirpath expressions can be run against"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"The subject of the questionnaire e.g ",(0,a.kt)("inlineCode",{parentName:"li"},"Patient.active")),(0,a.kt)("li",{parentName:"ol"},"The Bundle resource which contains the ",(0,a.kt)("inlineCode",{parentName:"li"},"QuestionnaireResponse"),", the ",(0,a.kt)("inlineCode",{parentName:"li"},"subject")," as well as additional resources. An example expression would be ",(0,a.kt)("inlineCode",{parentName:"li"},"%resource.entry.where(resource is QuestionnaireResponse).resource.where(questionnaire = 'Questionnaire/450cb100-0c5b-47c6-9f33-2830a79be726').exists()")),(0,a.kt)("li",{parentName:"ol"},"A combination of both the ",(0,a.kt)("inlineCode",{parentName:"li"},"subject")," and ",(0,a.kt)("inlineCode",{parentName:"li"},"Bundle")," e.g ",(0,a.kt)("inlineCode",{parentName:"li"},"Patient.active AND %resource.entry.where(resource is QuestionnaireResponse).resource.where(questionnaire = 'Questionnaire/450cb100-0c5b-47c6-9f33-2830a79be726').exists()"))),(0,a.kt)("p",null,"The event resources define which resource is eligible for closure as well as any related resources."),(0,a.kt)("p",null,"The data queries define how to search for and filter the resources from the database."),(0,a.kt)("p",null,"Once the resources have been retrieved from the database, the next step is to close the resources by updating the values of certain fields. For the current implementation this has been done in the code. This is not configurable at this point.\nClosure of any resource that has not been handled will need an update to the code that performs resource closure."),(0,a.kt)("p",null,"The following table contains the values for each field that is required to close a resource.field"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:"left"},"Resource"),(0,a.kt)("th",{parentName:"tr",align:"left"},"Field"),(0,a.kt)("th",{parentName:"tr",align:"left"},"Value"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"Careplan"),(0,a.kt)("td",{parentName:"tr",align:"left"},"status"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Completed")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"Task"),(0,a.kt)("td",{parentName:"tr",align:"left"},"status"),(0,a.kt)("td",{parentName:"tr",align:"left"},"cancelled")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"}),(0,a.kt)("td",{parentName:"tr",align:"left"},"lastModified"),(0,a.kt)("td",{parentName:"tr",align:"left"},"current date")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"Condition"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Condition.clinicalStatus"),(0,a.kt)("td",{parentName:"tr",align:"left"},"code:370996005, display:resolved, system: ",(0,a.kt)("a",{parentName:"td",href:"http://www.snomed.org/"},"http://www.snomed.org/"))),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"Procedure"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Procedure.status"),(0,a.kt)("td",{parentName:"tr",align:"left"},"stopped")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"ServiceRequest"),(0,a.kt)("td",{parentName:"tr",align:"left"},"status"),(0,a.kt)("td",{parentName:"tr",align:"left"},"revoked")))),(0,a.kt)("h2",{id:"eventworkflows-properties"},"EventWorkflows properties"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Property"),(0,a.kt)("th",{parentName:"tr",align:null},"Description"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Required"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Default"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"eventType"),(0,a.kt)("td",{parentName:"tr",align:null},"The intention of the eventWorkflow. E.g close resources"),(0,a.kt)("td",{parentName:"tr",align:"center"},"yes"),(0,a.kt)("td",{parentName:"tr",align:"center"},"RESOURCE_CLOSURE is supported for now")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"triggerConditions"),(0,a.kt)("td",{parentName:"tr",align:null},"This defines an array of condition for to be met for the event to run"),(0,a.kt)("td",{parentName:"tr",align:"center"},"no"),(0,a.kt)("td",{parentName:"tr",align:"center"},"null")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"eventResourceId"),(0,a.kt)("td",{parentName:"tr",align:null},"uniqueId of resource id to be closed"),(0,a.kt)("td",{parentName:"tr",align:"center"},"yes"),(0,a.kt)("td",{parentName:"tr",align:"center"})),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"eventResources"),(0,a.kt)("td",{parentName:"tr",align:null},"A list of resources to close(Type of ResourceConfig)"),(0,a.kt)("td",{parentName:"tr",align:"center"},"yes"),(0,a.kt)("td",{parentName:"tr",align:"center"})))),(0,a.kt)("h3",{id:"trigger-condition-properties"},"Trigger condition properties"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Property"),(0,a.kt)("th",{parentName:"tr",align:null},"Description"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Required"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Default"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"eventResourceId"),(0,a.kt)("td",{parentName:"tr",align:null},"UniqueId of resource that the trigger conditions are applied to"),(0,a.kt)("td",{parentName:"tr",align:"center"},"yes"),(0,a.kt)("td",{parentName:"tr",align:"center"},"RESOURCE_CLOSURE is supported for now")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"conditionalFhirPathExpressions"),(0,a.kt)("td",{parentName:"tr",align:null},"criteria to ensure we only close the intended resources"),(0,a.kt)("td",{parentName:"tr",align:"center"},"yes"),(0,a.kt)("td",{parentName:"tr",align:"center"})),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"matchAll"),(0,a.kt)("td",{parentName:"tr",align:null},"Determines whether all conditional fhirpath expressions should evaluate to true"),(0,a.kt)("td",{parentName:"tr",align:"center"},"no"),(0,a.kt)("td",{parentName:"tr",align:"center"},"True")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null}),(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"True")," - Close resources only when all fhirpath expressions evaluate to true"),(0,a.kt)("td",{parentName:"tr",align:"center"}),(0,a.kt)("td",{parentName:"tr",align:"center"})),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null}),(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"False")," - Close resources when one or more fhirpath expressions evaluate to true"),(0,a.kt)("td",{parentName:"tr",align:"center"}),(0,a.kt)("td",{parentName:"tr",align:"center"})))),(0,a.kt)("h3",{id:"event-resource-properties"},"Event Resource Properties"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Property"),(0,a.kt)("th",{parentName:"tr",align:null},"Description"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Required"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Default"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"id"),(0,a.kt)("td",{parentName:"tr",align:null},"uniqueId of resource id to be closed"),(0,a.kt)("td",{parentName:"tr",align:"center"},"yes"),(0,a.kt)("td",{parentName:"tr",align:"center"})),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"resource"),(0,a.kt)("td",{parentName:"tr",align:null},"The type of resource"),(0,a.kt)("td",{parentName:"tr",align:"center"},"yes"),(0,a.kt)("td",{parentName:"tr",align:"center"})),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"configRules"),(0,a.kt)("td",{parentName:"tr",align:null},"Rules to be that are executed to populate dynamic values such as a patient id"),(0,a.kt)("td",{parentName:"tr",align:"center"},"no"),(0,a.kt)("td",{parentName:"tr",align:"center"})),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"dataQueries"),(0,a.kt)("td",{parentName:"tr",align:null},"Configs used to represent how resources to be closed are retrieved from the database"),(0,a.kt)("td",{parentName:"tr",align:"center"},"yes"),(0,a.kt)("td",{parentName:"tr",align:"center"})),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"relatedResources"),(0,a.kt)("td",{parentName:"tr",align:null},"Configs that represent how to fetch related resources e.g Tasks linked to a CarePlan"),(0,a.kt)("td",{parentName:"tr",align:"center"},"no"),(0,a.kt)("td",{parentName:"tr",align:"center"})))),(0,a.kt)("h3",{id:"dataquery-properties"},"DataQuery properties"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Property"),(0,a.kt)("th",{parentName:"tr",align:null},"Description"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Required"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Default"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"paramName"),(0,a.kt)("td",{parentName:"tr",align:null},"String representation of the resource field to search on"),(0,a.kt)("td",{parentName:"tr",align:"center"},"yes"),(0,a.kt)("td",{parentName:"tr",align:"center"})),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"operation"),(0,a.kt)("td",{parentName:"tr",align:null},"Logical SQL operation to perform i.e AND, OR"),(0,a.kt)("td",{parentName:"tr",align:"center"},"yes"),(0,a.kt)("td",{parentName:"tr",align:"center"},"AND")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"filterCriteria"),(0,a.kt)("td",{parentName:"tr",align:null},"Configs that represent the datatype and value for filtering data"),(0,a.kt)("td",{parentName:"tr",align:"center"},"yes"),(0,a.kt)("td",{parentName:"tr",align:"center"})))))}u.isMDXComponent=!0}}]);