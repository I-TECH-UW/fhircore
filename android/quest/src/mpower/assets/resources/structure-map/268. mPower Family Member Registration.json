{
    "resourceType": "StructureMap",
    "id": "268",
    "meta": {
      "versionId": "3",
      "lastUpdated": "2023-05-09T06:17:27.709+00:00",
      "source": "#6UfPUPhKt89LfvmN"
    },
    "url": "http://fhir.mpower-social.com:7070/fhir/StructureMap/268",
    "name": "mPower Family Member Registration",
    "structure": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/QuestionnaireReponse",
        "mode": "source"
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/Bundle",
        "mode": "target"
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/Patient",
        "mode": "target"
      }
    ],
    "group": [
      {
        "name": "mPowerFamilyMemberRegistration",
        "typeMode": "none",
        "input": [
          {
            "name": "src",
            "type": "QuestionnaireResponse",
            "mode": "source"
          },
          {
            "name": "bundle",
            "type": "Bundle",
            "mode": "target"
          }
        ],
        "rule": [
          {
            "name": "rule_bundle_id",
            "source": [
              {
                "context": "src"
              }
            ],
            "target": [
              {
                "context": "bundle",
                "contextType": "variable",
                "element": "id",
                "transform": "uuid"
              }
            ]
          },
          {
            "name": "rule_bundle_type",
            "source": [
              {
                "context": "src"
              }
            ],
            "target": [
              {
                "context": "bundle",
                "contextType": "variable",
                "element": "type",
                "transform": "copy",
                "parameter": [
                  {
                    "valueString": "collection"
                  }
                ]
              }
            ]
          },
          {
            "name": "rule_bundle_entries",
            "source": [
              {
                "context": "src"
              }
            ],
            "target": [
              {
                "context": "bundle",
                "contextType": "variable",
                "element": "entry",
                "variable": "entry"
              },
              {
                "context": "entry",
                "contextType": "variable",
                "element": "resource",
                "variable": "patient",
                "transform": "create",
                "parameter": [
                  {
                    "valueString": "Patient"
                  }
                ]
              }
            ],
            "dependent": [
              {
                "name": "ExtractPatient",
                "variable": [
                  "src",
                  "patient",
                  "bundle"
                ]
              },
              {
                "name": "ExtractEncounter",
                "variable": [
                  "src",
                  "bundle"
                ]
              }
            ]
          }
        ]
      },
      {
        "name": "ExtractPatient",
        "typeMode": "none",
        "input": [
          {
            "name": "src",
            "type": "QuestionnaireResponse",
            "mode": "source"
          },
          {
            "name": "patient",
            "type": "Patient",
            "mode": "target"
          },
          {
            "name": "bundle",
            "type": "Bundle",
            "mode": "target"
          }
        ],
        "rule": [
          {
            "name": "rule_patient_id_generation",
            "source": [
              {
                "context": "src"
              }
            ],
            "target": [
              {
                "context": "patient",
                "contextType": "variable",
                "element": "id",
                "transform": "uuid"
              }
            ]
          },
          {
            "name": "rule_patient_name",
            "source": [
              {
                "context": "src"
              }
            ],
            "target": [
              {
                "context": "patient",
                "contextType": "variable",
                "element": "name",
                "variable": "patientName",
                "transform": "create",
                "parameter": [
                  {
                    "valueString": "HumanName"
                  }
                ]
              }
            ],
            "rule": [
              {
                "name": "rule_patient_family_name",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "patientName",
                    "contextType": "variable",
                    "element": "family",
                    "transform": "evaluate",
                    "parameter": [
                      {
                        "valueId": "src"
                      },
                      {
                        "valueString": "$this.item.where(linkId = '8fb87910-d900-4eea-dbba-dcf76ee6806d').answer.value"
                      }
                    ]
                  }
                ]
              },
              {
                "name": "rule_patient_given_name",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "patientName",
                    "contextType": "variable",
                    "element": "given",
                    "transform": "evaluate",
                    "parameter": [
                      {
                        "valueId": "src"
                      },
                      {
                        "valueString": "$this.item.where(linkId = 'e6306275-b989-4375-8527-3a56092081b8').answer.value"
                      }
                    ]
                  }
                ]
              },
              {
                "name": "rule_patient_middle_name",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "patientName",
                    "contextType": "variable",
                    "element": "text",
                    "transform": "evaluate",
                    "parameter": [
                      {
                        "valueId": "src"
                      },
                      {
                        "valueString": "$this.item.where(linkId = '597f4425-72b3-4bc4-8f38-b742aa3e99cd').answer.value"
                      }
                    ]
                  }
                ]
              },
              {
                "name": "rule_patient_name_use",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "patientName",
                    "contextType": "variable",
                    "element": "use",
                    "transform": "copy",
                    "parameter": [
                      {
                        "valueString": "official"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "name": "rule_patient_identifier_opensrp",
            "source": [
              {
                "context": "src"
              }
            ],
            "target": [
              {
                "context": "patient",
                "contextType": "variable",
                "element": "identifier",
                "variable": "patientIdentifierOpenSRPId",
                "transform": "create",
                "parameter": [
                  {
                    "valueString": "Identifier"
                  }
                ]
              }
            ],
            "rule": [
              {
                "name": "rule_patient_identifier_opensrp_id_value",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "patientIdentifierOpenSRPId",
                    "contextType": "variable",
                    "element": "value",
                    "transform": "evaluate",
                    "parameter": [
                      {
                        "valueId": "src"
                      },
                      {
                        "valueString": "$this.item.where(linkId = 'ed77104e-c279-4030-ab20-8cd99ca99ca9').answer.value"
                      }
                    ]
                  }
                ]
              },
              {
                "name": "rule_patient_identifier_opensrp_id_use",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "patientIdentifierOpenSRPId",
                    "contextType": "variable",
                    "element": "use",
                    "transform": "copy",
                    "parameter": [
                      {
                        "valueString": "official"
                      }
                    ]
                  }
                ]
              },
              {
                "name": "rule_patient_identifier_period",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "patientIdentifierOpenSRPId",
                    "contextType": "variable",
                    "element": "period",
                    "variable": "period",
                    "transform": "create",
                    "parameter": [
                      {
                        "valueString": "Period"
                      }
                    ]
                  },
                  {
                    "context": "period",
                    "contextType": "variable",
                    "element": "start",
                    "transform": "evaluate",
                    "parameter": [
                      {
                        "valueId": "src"
                      },
                      {
                        "valueString": "$this.authored"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "name": "rule_patient_identifier_national_id",
            "source": [
              {
                "context": "src"
              }
            ],
            "target": [
              {
                "context": "patient",
                "contextType": "variable",
                "element": "identifier",
                "variable": "patientIdentifierNationalId",
                "transform": "create",
                "parameter": [
                  {
                    "valueString": "Identifier"
                  }
                ]
              }
            ],
            "rule": [
              {
                "name": "rule_patient_identifier_national_id_value",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "patientIdentifierNationalId",
                    "contextType": "variable",
                    "element": "value",
                    "transform": "evaluate",
                    "parameter": [
                      {
                        "valueId": "src"
                      },
                      {
                        "valueString": "$this.item.where(linkId = '06cbc503-3fa3-49f4-d0d7-9f427c0c6dd9').answer.value"
                      }
                    ]
                  }
                ]
              },
              {
                "name": "rule_patient_identifier_national_id_use",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "patientIdentifierNationalId",
                    "contextType": "variable",
                    "element": "use",
                    "transform": "copy",
                    "parameter": [
                      {
                        "valueString": "usual"
                      }
                    ]
                  }
                ]
              },
              {
                "name": "rule_patient_identifier_period",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "patientIdentifierNationalId",
                    "contextType": "variable",
                    "element": "period",
                    "variable": "period",
                    "transform": "create",
                    "parameter": [
                      {
                        "valueString": "Period"
                      }
                    ]
                  },
                  {
                    "context": "period",
                    "contextType": "variable",
                    "element": "start",
                    "transform": "evaluate",
                    "parameter": [
                      {
                        "valueId": "src"
                      },
                      {
                        "valueString": "$this.authored"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "name": "rule_patient_identifier",
            "source": [
              {
                "context": "src"
              }
            ],
            "target": [
              {
                "context": "patient",
                "contextType": "variable",
                "element": "identifier",
                "variable": "patientIdentifier",
                "transform": "create",
                "parameter": [
                  {
                    "valueString": "Identifier"
                  }
                ]
              }
            ],
            "rule": [
              {
                "name": "rule_patient_identifier_value",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "patientIdentifier",
                    "contextType": "variable",
                    "element": "value",
                    "transform": "uuid"
                  }
                ]
              },
              {
                "name": "rule_patient_identifier_use",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "patientIdentifier",
                    "contextType": "variable",
                    "element": "use",
                    "transform": "copy",
                    "parameter": [
                      {
                        "valueString": "secondary"
                      }
                    ]
                  }
                ]
              },
              {
                "name": "rule_patient_identifier_period",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "patientIdentifier",
                    "contextType": "variable",
                    "element": "period",
                    "variable": "period",
                    "transform": "create",
                    "parameter": [
                      {
                        "valueString": "Period"
                      }
                    ]
                  },
                  {
                    "context": "period",
                    "contextType": "variable",
                    "element": "start",
                    "transform": "evaluate",
                    "parameter": [
                      {
                        "valueId": "src"
                      },
                      {
                        "valueString": "$this.authored"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "name": "rule_patient_gender",
            "source": [
              {
                "context": "src"
              }
            ],
            "target": [
              {
                "context": "patient",
                "contextType": "variable",
                "element": "gender",
                "transform": "evaluate",
                "parameter": [
                  {
                    "valueId": "src"
                  },
                  {
                    "valueString": "$this.item.where(linkId = '77e32953-0679-48b5-f004-1ab4a4ac0271').answer.value.code"
                  }
                ]
              }
            ]
          },
          {
            "name": "rule_patient_dob",
            "source": [
              {
                "context": "src",
                "element": "item",
                "variable": "patient_dob",
                "condition": "(linkId = 'cd8e3d6d-e9ff-458d-d122-57070bebffaf')"
              }
            ],
            "rule": [
              {
                "name": "rule__first_patient_dob",
                "source": [
                  {
                    "context": "patient_dob",
                    "element": "answer",
                    "listMode": "first",
                    "variable": "patientBirthDateAnswer"
                  }
                ],
                "rule": [
                  {
                    "name": "rule_patient_dob_answer",
                    "source": [
                      {
                        "context": "patientBirthDateAnswer",
                        "element": "value",
                        "variable": "val"
                      }
                    ],
                    "target": [
                      {
                        "context": "patient",
                        "contextType": "variable",
                        "element": "birthDate",
                        "transform": "copy",
                        "parameter": [
                          {
                            "valueId": "val"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "name": "rule_calculate_new_date_today",
                    "source": [
                      {
                        "context": "src",
                        "element": "item",
                        "variable": "calculate_new_date_today"
                      }
                    ],
                    "target": [
                      {
                        "variable": "new_date",
                        "transform": "evaluate",
                        "parameter": [
                          {
                            "valueId": "src"
                          },
                          {
                            "valueString": "(today() - ((365 * 15).toString() + ' days').toQuantity())"
                          }
                        ]
                      }
                    ],
                    "rule": [
                      {
                        "name": "rule_patient_date_of_birth",
                        "source": [
                          {
                            "context": "calculate_new_date_today",
                            "variable": "patient_date_of_birth",
                            "condition": "(linkId = 'cd8e3d6d-e9ff-458d-d122-57070bebffaf')"
                          }
                        ],
                        "rule": [
                          {
                            "name": "rule_patient_date_of_birth_answer",
                            "source": [
                              {
                                "context": "patient_date_of_birth",
                                "element": "answer",
                                "listMode": "first",
                                "variable": "patient_date_of_birth_answer"
                              }
                            ],
                            "rule": [
                              {
                                "name": "rule_patient_date_of_birth_answer_value",
                                "source": [
                                  {
                                    "context": "patient_date_of_birth_answer",
                                    "element": "value",
                                    "variable": "patient_date_of_birth_answer_value"
                                  }
                                ],
                                "rule": [
                                  {
                                    "name": "rule_patient_age_compare_with_today",
                                    "source": [
                                      {
                                        "context": "patient_date_of_birth_answer_value",
                                        "variable": "patient_age_compare_with_today",
                                        "condition": "(patient_date_of_birth_answer_value <= new_date)"
                                      }
                                    ],
                                    "rule": [
                                      {
                                        "name": "household_head_trigger_check",
                                        "source": [
                                          {
                                            "context": "src",
                                            "element": "item",
                                            "variable": "head_of_household_check",
                                            "condition": "((linkId = '1e1a206f-1cc2-4e48-8103-b26bf4bd7c3c') and (answer.value = 'yes'))"
                                          }
                                        ],
                                        "rule": [
                                          {
                                            "name": "rule_related_person_creation",
                                            "source": [
                                              {
                                                "context": "head_of_household_check"
                                              }
                                            ],
                                            "target": [
                                              {
                                                "context": "bundle",
                                                "contextType": "variable",
                                                "element": "entry",
                                                "variable": "entry"
                                              },
                                              {
                                                "context": "entry",
                                                "contextType": "variable",
                                                "element": "resource",
                                                "variable": "relatedPerson",
                                                "transform": "create",
                                                "parameter": [
                                                  {
                                                    "valueString": "RelatedPerson"
                                                  }
                                                ]
                                              }
                                            ],
                                            "rule": [
                                              {
                                                "name": "rule_related_person_reference",
                                                "source": [
                                                  {
                                                    "context": "src"
                                                  }
                                                ],
                                                "dependent": [
                                                  {
                                                    "name": "ExtractRelatedPerson",
                                                    "variable": [
                                                      "patient",
                                                      "relatedPerson"
                                                    ]
                                                  }
                                                ]
                                              }
                                            ]
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "name": "rule_patient_age",
            "source": [
              {
                "context": "src",
                "element": "item",
                "variable": "patient_age",
                "condition": "((linkId = '8460d986-ef71-4997-80ee-7887d8c345e7') and (answer.value > 0))"
              }
            ],
            "target": [
              {
                "context": "patient",
                "contextType": "variable",
                "element": "birthDate",
                "transform": "evaluate",
                "parameter": [
                  {
                    "valueId": "patient_age"
                  },
                  {
                    "valueString": "today() - (($this.answer.value * 365.5).toString() + ' days').toQuantity()"
                  }
                ]
              }
            ]
          },
          {
            "name": "r_patient_age",
            "source": [
              {
                "context": "src",
                "element": "item",
                "variable": "patient_age",
                "condition": "((linkId = '8460d986-ef71-4997-80ee-7887d8c345e7') and (answer.value > 0))"
              }
            ],
            "rule": [
              {
                "name": "r_actual_dob",
                "source": [
                  {
                    "context": "patient_age",
                    "variable": "age"
                  }
                ],
                "target": [
                  {
                    "variable": "actual_dob",
                    "transform": "evaluate",
                    "parameter": [
                      {
                        "valueId": "patient_age"
                      },
                      {
                        "valueString": "today() - (($this.answer.value * 365.5).toString() + ' days').toQuantity()"
                      }
                    ]
                  }
                ],
                "rule": [
                  {
                    "name": "rule_calculate_new_date_today",
                    "source": [
                      {
                        "context": "patient_age",
                        "variable": "calculate_new_date_today"
                      }
                    ],
                    "target": [
                      {
                        "variable": "new_date",
                        "transform": "evaluate",
                        "parameter": [
                          {
                            "valueId": "src"
                          },
                          {
                            "valueString": "(today() - ((365 * 15).toString() + ' days').toQuantity())"
                          }
                        ]
                      }
                    ],
                    "rule": [
                      {
                        "name": "rule_patient_age_compare_with_today",
                        "source": [
                          {
                            "context": "patient_age",
                            "variable": "patient_age_compare_with_today",
                            "condition": "(actual_dob <= new_date)"
                          }
                        ],
                        "rule": [
                          {
                            "name": "household_head_trigger_check",
                            "source": [
                              {
                                "context": "src",
                                "element": "item",
                                "variable": "head_of_household_check",
                                "condition": "((linkId = '1e1a206f-1cc2-4e48-8103-b26bf4bd7c3c') and (answer.value = 'yes'))"
                              }
                            ],
                            "rule": [
                              {
                                "name": "rule_related_person_creation",
                                "source": [
                                  {
                                    "context": "head_of_household_check"
                                  }
                                ],
                                "target": [
                                  {
                                    "context": "bundle",
                                    "contextType": "variable",
                                    "element": "entry",
                                    "variable": "entry"
                                  },
                                  {
                                    "context": "entry",
                                    "contextType": "variable",
                                    "element": "resource",
                                    "variable": "relatedPerson",
                                    "transform": "create",
                                    "parameter": [
                                      {
                                        "valueString": "RelatedPerson"
                                      }
                                    ]
                                  }
                                ],
                                "rule": [
                                  {
                                    "name": "rule_related_person_reference",
                                    "source": [
                                      {
                                        "context": "src"
                                      }
                                    ],
                                    "dependent": [
                                      {
                                        "name": "ExtractRelatedPerson",
                                        "variable": [
                                          "patient",
                                          "relatedPerson"
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "name": "rule_patient_active",
            "source": [
              {
                "context": "src"
              }
            ],
            "target": [
              {
                "context": "patient",
                "contextType": "variable",
                "element": "active",
                "transform": "copy",
                "parameter": [
                  {
                    "valueBoolean": true
                  }
                ]
              }
            ]
          },
          {
            "name": "rule_patient_address",
            "source": [
              {
                "context": "src"
              }
            ],
            "target": [
              {
                "context": "patient",
                "contextType": "variable",
                "element": "address",
                "variable": "patientAddress",
                "transform": "create",
                "parameter": [
                  {
                    "valueString": "Address"
                  }
                ]
              }
            ],
            "rule": [
              {
                "name": "rule_patient_address_district",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "patientAddress",
                    "contextType": "variable",
                    "element": "district",
                    "transform": "evaluate",
                    "parameter": [
                      {
                        "valueId": "src"
                      },
                      {
                        "valueString": "$this.item.where(linkId = '7d9dba4c-7407-4eb2-d791-2d1834b6afcc').answer.value"
                      }
                    ]
                  }
                ]
              },
              {
                "name": "rule_patient_address_use",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "patientAddress",
                    "contextType": "variable",
                    "element": "use",
                    "transform": "copy",
                    "parameter": [
                      {
                        "valueString": "home"
                      }
                    ]
                  }
                ]
              },
              {
                "name": "rule_patient_address_type",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "patientAddress",
                    "contextType": "variable",
                    "element": "type",
                    "transform": "copy",
                    "parameter": [
                      {
                        "valueString": "physical"
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      },
      {
        "name": "ExtractRelatedPerson",
        "typeMode": "none",
        "input": [
          {
            "name": "src",
            "type": "Patient",
            "mode": "source"
          },
          {
            "name": "relatedPerson",
            "type": "RelatedPerson",
            "mode": "target"
          }
        ],
        "rule": [
          {
            "name": "rule_related_person",
            "source": [
              {
                "context": "src"
              }
            ],
            "target": [
              {
                "context": "relatedPerson",
                "contextType": "variable",
                "element": "id",
                "transform": "uuid"
              }
            ]
          },
          {
            "name": "rule_related_person_identifier",
            "source": [
              {
                "context": "src"
              }
            ],
            "target": [
              {
                "context": "relatedPerson",
                "contextType": "variable",
                "element": "identifier",
                "variable": "relatedPersonIdentifier",
                "transform": "create",
                "parameter": [
                  {
                    "valueString": "Identifier"
                  }
                ]
              }
            ],
            "rule": [
              {
                "name": "rule_related_person_identifier_value",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "relatedPersonIdentifier",
                    "contextType": "variable",
                    "element": "value",
                    "transform": "uuid"
                  }
                ]
              },
              {
                "name": "rule_related_person_identifier_use",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "relatedPersonIdentifier",
                    "contextType": "variable",
                    "element": "use",
                    "transform": "copy",
                    "parameter": [
                      {
                        "valueString": "secondary"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "name": "rule_related_person_name",
            "source": [
              {
                "context": "src"
              }
            ],
            "target": [
              {
                "context": "relatedPerson",
                "contextType": "variable",
                "element": "name",
                "variable": "relatedPersonName",
                "transform": "create",
                "parameter": [
                  {
                    "valueString": "HumanName"
                  }
                ]
              }
            ],
            "rule": [
              {
                "name": "rule_related_person_family_name",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "relatedPersonName",
                    "contextType": "variable",
                    "element": "family",
                    "transform": "evaluate",
                    "parameter": [
                      {
                        "valueId": "src"
                      },
                      {
                        "valueString": "$this.name.family"
                      }
                    ]
                  }
                ]
              },
              {
                "name": "rule_related_person_given_name",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "relatedPersonName",
                    "contextType": "variable",
                    "element": "given",
                    "transform": "evaluate",
                    "parameter": [
                      {
                        "valueId": "src"
                      },
                      {
                        "valueString": "$this.name.given"
                      }
                    ]
                  }
                ]
              },
              {
                "name": "rule_related_person_middle_name",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "relatedPersonName",
                    "contextType": "variable",
                    "element": "text",
                    "transform": "evaluate",
                    "parameter": [
                      {
                        "valueId": "src"
                      },
                      {
                        "valueString": "$this.name.text"
                      }
                    ]
                  }
                ]
              },
              {
                "name": "rule_related_person_name_use",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "relatedPersonName",
                    "contextType": "variable",
                    "element": "use",
                    "transform": "copy",
                    "parameter": [
                      {
                        "valueString": "official"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "name": "rule_related_person_active",
            "source": [
              {
                "context": "src"
              }
            ],
            "target": [
              {
                "context": "relatedPerson",
                "contextType": "variable",
                "element": "active",
                "transform": "copy",
                "parameter": [
                  {
                    "valueBoolean": true
                  }
                ]
              }
            ]
          },
          {
            "name": "rule_related_person_relationship",
            "source": [
              {
                "context": "src"
              }
            ],
            "target": [
              {
                "context": "relatedPerson",
                "contextType": "variable",
                "element": "relationship",
                "variable": "concept",
                "transform": "create",
                "parameter": [
                  {
                    "valueString": "CodeableConcept"
                  }
                ]
              }
            ],
            "rule": [
              {
                "name": "r_en_cc_cod",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "concept",
                    "contextType": "variable",
                    "element": "coding",
                    "variable": "coding",
                    "transform": "c",
                    "parameter": [
                      {
                        "valueString": "http://snomed.info/sct"
                      },
                      {
                        "valueString": "99990006"
                      }
                    ]
                  }
                ],
                "rule": [
                  {
                    "name": "r_en_cod_disp",
                    "source": [
                      {
                        "context": "src"
                      }
                    ],
                    "target": [
                      {
                        "context": "coding",
                        "contextType": "variable",
                        "element": "display",
                        "transform": "copy",
                        "parameter": [
                          {
                            "valueString": "Family Head"
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "name": "rule_related_person_patient",
            "source": [
              {
                "context": "src"
              }
            ],
            "target": [
              {
                "context": "relatedPerson",
                "contextType": "variable",
                "element": "patient",
                "variable": "ref",
                "transform": "create",
                "parameter": [
                  {
                    "valueString": "Reference"
                  }
                ]
              }
            ],
            "rule": [
              {
                "name": "rule_related_person_patient_ref",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "ref",
                    "contextType": "variable",
                    "element": "reference",
                    "transform": "evaluate",
                    "parameter": [
                      {
                        "valueId": "src"
                      },
                      {
                        "valueString": "'Patient/' + $this.id"
                      }
                    ]
                  }
                ]
              },
              {
                "name": "rule_related_person_patient_ref_display",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "ref",
                    "contextType": "variable",
                    "element": "display",
                    "transform": "evaluate",
                    "parameter": [
                      {
                        "valueId": "src"
                      },
                      {
                        "valueString": "relatedPerson.name.given + ' ' + relatedPerson.name.text + ' ' + relatedPerson.name.family"
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      },
      {
        "name": "ExtractEncounter",
        "typeMode": "none",
        "input": [
          {
            "name": "src",
            "type": "QuestionnaireResponse",
            "mode": "source"
          },
          {
            "name": "bundle",
            "type": "Bundle",
            "mode": "target"
          }
        ],
        "rule": [
          {
            "name": "r_en",
            "source": [
              {
                "context": "src"
              }
            ],
            "target": [
              {
                "context": "bundle",
                "contextType": "variable",
                "element": "entry",
                "variable": "entry"
              },
              {
                "context": "entry",
                "contextType": "variable",
                "element": "resource",
                "variable": "encounter",
                "transform": "create",
                "parameter": [
                  {
                    "valueString": "Encounter"
                  }
                ]
              }
            ],
            "rule": [
              {
                "name": "r_en_id",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "encounter",
                    "contextType": "variable",
                    "element": "id",
                    "transform": "uuid"
                  }
                ]
              },
              {
                "name": "r_en_st",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "encounter",
                    "contextType": "variable",
                    "element": "status",
                    "transform": "copy",
                    "parameter": [
                      {
                        "valueString": "finished"
                      }
                    ]
                  }
                ]
              },
              {
                "name": "r_en_cls",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "encounter",
                    "contextType": "variable",
                    "element": "class",
                    "transform": "c",
                    "parameter": [
                      {
                        "valueString": "http://terminology.hl7.org/CodeSystem/v3-ActCode"
                      },
                      {
                        "valueString": "HH"
                      },
                      {
                        "valueString": "Home Health"
                      }
                    ]
                  }
                ]
              },
              {
                "name": "r_en_typ",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "encounter",
                    "contextType": "variable",
                    "element": "type",
                    "variable": "concept",
                    "transform": "create",
                    "parameter": [
                      {
                        "valueString": "CodeableConcept"
                      }
                    ]
                  }
                ],
                "rule": [
                  {
                    "name": "r_en_cc_cod",
                    "source": [
                      {
                        "context": "src"
                      }
                    ],
                    "target": [
                      {
                        "context": "concept",
                        "contextType": "variable",
                        "element": "coding",
                        "variable": "coding",
                        "transform": "c",
                        "parameter": [
                          {
                            "valueString": "http://snomed.info/sct"
                          },
                          {
                            "valueString": "77386006"
                          }
                        ]
                      }
                    ],
                    "rule": [
                      {
                        "name": "r_en_cod_disp",
                        "source": [
                          {
                            "context": "src"
                          }
                        ],
                        "target": [
                          {
                            "context": "coding",
                            "contextType": "variable",
                            "element": "display",
                            "transform": "copy",
                            "parameter": [
                              {
                                "valueString": "Consultation"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "name": "r_en_typ_text",
                    "source": [
                      {
                        "context": "src"
                      }
                    ],
                    "target": [
                      {
                        "context": "concept",
                        "contextType": "variable",
                        "element": "text",
                        "transform": "copy",
                        "parameter": [
                          {
                            "valueString": "Consultation"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "name": "r_en_prio",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "encounter",
                    "contextType": "variable",
                    "element": "priority",
                    "variable": "concept",
                    "transform": "create",
                    "parameter": [
                      {
                        "valueString": "CodeableConcept"
                      }
                    ]
                  }
                ],
                "rule": [
                  {
                    "name": "r_en_cc_cod",
                    "source": [
                      {
                        "context": "src"
                      }
                    ],
                    "target": [
                      {
                        "context": "concept",
                        "contextType": "variable",
                        "element": "coding",
                        "variable": "coding",
                        "transform": "c",
                        "parameter": [
                          {
                            "valueString": "http://snomed.info/sct"
                          },
                          {
                            "valueString": "17621005"
                          }
                        ]
                      }
                    ],
                    "rule": [
                      {
                        "name": "r_en_cod_disp",
                        "source": [
                          {
                            "context": "src"
                          }
                        ],
                        "target": [
                          {
                            "context": "coding",
                            "contextType": "variable",
                            "element": "display",
                            "transform": "copy",
                            "parameter": [
                              {
                                "valueString": "Normal"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "name": "r_en_prio_text",
                    "source": [
                      {
                        "context": "src"
                      }
                    ],
                    "target": [
                      {
                        "context": "concept",
                        "contextType": "variable",
                        "element": "text",
                        "transform": "copy",
                        "parameter": [
                          {
                            "valueString": "Normal"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "name": "r_en_sub",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "encounter",
                    "contextType": "variable",
                    "element": "subject",
                    "transform": "evaluate",
                    "parameter": [
                      {
                        "valueId": "src"
                      },
                      {
                        "valueString": "$this.subject"
                      }
                    ]
                  }
                ]
              },
              {
                "name": "r_en_per",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "encounter",
                    "contextType": "variable",
                    "element": "period",
                    "variable": "enPeriod",
                    "transform": "create",
                    "parameter": [
                      {
                        "valueString": "Period"
                      }
                    ]
                  }
                ],
                "rule": [
                  {
                    "name": "r_en_per_start",
                    "source": [
                      {
                        "context": "src"
                      }
                    ],
                    "target": [
                      {
                        "context": "enPeriod",
                        "contextType": "variable",
                        "element": "start",
                        "transform": "evaluate",
                        "parameter": [
                          {
                            "valueId": "src"
                          },
                          {
                            "valueString": "now()"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "name": "r_en_per_end",
                    "source": [
                      {
                        "context": "src"
                      }
                    ],
                    "target": [
                      {
                        "context": "enPeriod",
                        "contextType": "variable",
                        "element": "end",
                        "transform": "evaluate",
                        "parameter": [
                          {
                            "valueId": "src"
                          },
                          {
                            "valueString": "now()"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "name": "r_en_reason",
                "source": [
                  {
                    "context": "src"
                  }
                ],
                "target": [
                  {
                    "context": "encounter",
                    "contextType": "variable",
                    "element": "reasonCode",
                    "variable": "concept",
                    "transform": "create",
                    "parameter": [
                      {
                        "valueString": "CodeableConcept"
                      }
                    ]
                  }
                ],
                "rule": [
                  {
                    "name": "r_en_rc_cod",
                    "source": [
                      {
                        "context": "src"
                      }
                    ],
                    "target": [
                      {
                        "context": "concept",
                        "contextType": "variable",
                        "element": "coding",
                        "variable": "coding",
                        "transform": "c",
                        "parameter": [
                          {
                            "valueString": "http://smartregsiter.org/"
                          },
                          {
                            "valueString": "family_member_registration"
                          }
                        ]
                      }
                    ],
                    "rule": [
                      {
                        "name": "r_en_rc_cod_disp",
                        "source": [
                          {
                            "context": "src"
                          }
                        ],
                        "target": [
                          {
                            "context": "coding",
                            "contextType": "variable",
                            "element": "display",
                            "transform": "copy",
                            "parameter": [
                              {
                                "valueString": "mPower Family Member Registration"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "name": "r_en_text",
                    "source": [
                      {
                        "context": "src"
                      }
                    ],
                    "target": [
                      {
                        "context": "concept",
                        "contextType": "variable",
                        "element": "text",
                        "transform": "copy",
                        "parameter": [
                          {
                            "valueString": "mPower Family Member Registration"
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  }