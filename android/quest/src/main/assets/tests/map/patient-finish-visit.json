{
  "resourceType": "StructureMap",
  "id": "patient-finish-visit",
  "url": "https://fhir-dev.d-tree.org/fhir/StructureMap/patient-finish-visit",
  "name": "Patient Finish Visit",
  "structure": [
    {
      "url": "http://hl7.org/fhir/StructureDefinition/QuestionnaireResponse",
      "mode": "source"
    },
    {
      "url": "http://hl7.org/fhir/StructureDefinition/Bundle",
      "mode": "target"
    },
    {
      "url": "http://hl7.org/fhir/StructureDefinition/Encounter",
      "mode": "target"
    },
    {
      "url": "http://hl7.org/fhir/StructureDefinition/Observation",
      "mode": "target"
    }
  ],
  "group": [
    {
      "name": "Main",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_bundle_data",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "bundle",
              "contextType": "variable",
              "element": "id",
              "transform": "uuid"
            },
            {
              "context": "bundle",
              "contextType": "variable",
              "element": "type",
              "transform": "copy",
              "parameter": [
                {
                  "valueString": "collection"
                }
              ]
            }
          ],
          "dependent": [
            {
              "name": "ExtractEncounter",
              "variable": [
                "src",
                "bundle"
              ]
            },
            {
              "name": "CloseCarePlan",
              "variable": [
                "src",
                "bundle"
              ]
            },
            {
              "name": "UpdateCurrentTracingTasks",
              "variable": [
                "src",
                "bundle"
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "ExtractEncounter",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_encounter",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "bundle",
              "contextType": "variable",
              "element": "entry",
              "variable": "entry"
            },
            {
              "context": "entry",
              "contextType": "variable",
              "element": "resource",
              "variable": "encounter",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "Encounter"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_enc_data",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "encounter",
                  "contextType": "variable",
                  "element": "id",
                  "transform": "uuid"
                },
                {
                  "context": "encounter",
                  "contextType": "variable",
                  "element": "status",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "finished"
                    }
                  ]
                },
                {
                  "context": "encounter",
                  "contextType": "variable",
                  "element": "class",
                  "transform": "c",
                  "parameter": [
                    {
                      "valueString": "http://terminology.hl7.org/CodeSystem/v3-ActCode"
                    },
                    {
                      "valueString": "IMP"
                    },
                    {
                      "valueString": "inpatient encounter"
                    }
                  ]
                },
                {
                  "context": "encounter",
                  "contextType": "variable",
                  "element": "serviceType",
                  "transform": "cc",
                  "parameter": [
                    {
                      "valueString": "https://d-tree.org"
                    },
                    {
                      "valueString": "patient-finish-visit"
                    },
                    {
                      "valueString": "Patient Finish Visit"
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_enc_subject",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "encounter",
                  "contextType": "variable",
                  "element": "subject",
                  "variable": "ref",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Reference"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_enc_subject_ref",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "ref",
                      "contextType": "variable",
                      "element": "reference",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "'Patient/' + $this.item.where(linkId = 'patient-id').answer.value"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_extract_observations",
              "source": [
                {
                  "context": "src"
                }
              ],
              "dependent": [
                {
                  "name": "ExtractObservations",
                  "variable": [
                    "src",
                    "bundle",
                    "encounter"
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "ExtractObservations",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        },
        {
          "name": "encounter",
          "type": "Encounter",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_ext_obs",
          "source": [
            {
              "context": "src"
            }
          ],
          "dependent": [
            {
              "name": "ExtractDateOfNextAppointment",
              "variable": [
                "src",
                "bundle",
                "encounter"
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "ExtractDateOfNextAppointment",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        },
        {
          "name": "encounter",
          "type": "Encounter",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_obs_item_date_of_next_appointment",
          "source": [
            {
              "context": "src",
              "element": "item",
              "variable": "item",
              "condition": "((linkId = 'date-of-next-appointment') and (answer.count() > 0))"
            }
          ],
          "target": [
            {
              "variable": "nextAppoinmentDateString",
              "transform": "evaluate",
              "parameter": [
                {
                  "valueId": "item"
                },
                {
                  "valueString": "$this.answer.value.toString()"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_obs_date_of_next_appointment",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "bundle",
                  "contextType": "variable",
                  "element": "entry",
                  "variable": "entry"
                },
                {
                  "context": "entry",
                  "contextType": "variable",
                  "element": "resource",
                  "variable": "obs",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Observation"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_obs_data_date_of_next_appointment",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "obs",
                      "contextType": "variable",
                      "element": "id",
                      "transform": "uuid"
                    },
                    {
                      "context": "obs",
                      "contextType": "variable",
                      "element": "code",
                      "transform": "cc",
                      "parameter": [
                        {
                          "valueString": "https://d-tree.og"
                        },
                        {
                          "valueString": "patient-finish-visit-date-of-next-appointment"
                        }
                      ]
                    },
                    {
                      "context": "obs",
                      "contextType": "variable",
                      "element": "category",
                      "transform": "cc",
                      "parameter": [
                        {
                          "valueString": "http://terminology.hl7.org/CodeSystem/observation-category"
                        },
                        {
                          "valueString": "vital-signs"
                        }
                      ]
                    },
                    {
                      "context": "obs",
                      "contextType": "variable",
                      "element": "encounter",
                      "transform": "reference",
                      "parameter": [
                        {
                          "valueId": "encounter"
                        }
                      ]
                    },
                    {
                      "context": "obs",
                      "contextType": "variable",
                      "element": "effective",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "now()"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_obs_sub_date_of_next_appointment",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "obs",
                      "contextType": "variable",
                      "element": "subject",
                      "variable": "ref",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Reference"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_obs_sub_ref_date_of_next_appointment",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "ref",
                          "contextType": "variable",
                          "element": "reference",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "'Patient/' + $this.item.where(linkId = 'patient-id').answer.value"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_obs_value_date_of_next_appointment",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "obs",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueId": "nextAppoinmentDateString"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_assign_appointment",
              "source": [
                {
                  "context": "src"
                }
              ],
              "dependent": [
                {
                  "name": "ExtractARTNewAppointmentWithStart",
                  "variable": [
                    "src",
                    "nextAppoinmentDateString",
                    "bundle"
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "AssignCarePlan",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_create_care_plan_title_string",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "variable": "title",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_patient_category",
              "source": [
                {
                  "context": "src",
                  "element": "item",
                  "variable": "item",
                  "condition": "(linkId = 'patient-category')"
                }
              ],
              "rule": [
                {
                  "name": "r_item_create_care_plan_exposed_infant",
                  "source": [
                    {
                      "context": "item",
                      "condition": "(answer.value.code = 'exposed-infant')"
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_extract_careplan_title",
                      "source": [
                        {
                          "context": "src",
                          "element": "item",
                          "listMode": "first",
                          "variable": "careplan_title",
                          "condition": "(linkId = 'patient-careplan-title')"
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_extract_visit_number",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "variable": "visit_number",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "careplan_title"
                                },
                                {
                                  "valueString": "$this.answer.value.substring(21, 32)"
                                }
                              ]
                            }
                          ],
                          "rule": [
                            {
                              "name": "r_assign_value",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "title",
                                  "contextType": "variable",
                                  "element": "value",
                                  "transform": "copy",
                                  "parameter": [
                                    {
                                      "valueString": "Exposed Infant Visit "
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "name": "r_append_visit_number",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "title",
                                  "contextType": "variable",
                                  "element": "value",
                                  "transform": "evaluate",
                                  "parameter": [
                                    {
                                      "valueId": "src"
                                    },
                                    {
                                      "valueString": "title.value + (visit_number.toInteger() + 1).toString()"
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "name": "r_create_care_exposed_infant_client",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "dependent": [
                                {
                                  "name": "CreateCarePlan",
                                  "variable": [
                                    "src",
                                    "bundle",
                                    "title"
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_item_create_care_plan_newly_diagnosed_client",
                  "source": [
                    {
                      "context": "item",
                      "condition": "(answer.value.code = 'newly-diagnosed-client')"
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_extract_careplan_title",
                      "source": [
                        {
                          "context": "src",
                          "element": "item",
                          "listMode": "first",
                          "variable": "careplan_title",
                          "condition": "(linkId = 'patient-careplan-title')"
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_extract_visit_number",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "variable": "visit_number",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "careplan_title"
                                },
                                {
                                  "valueString": "$this.answer.value.substring(29, 32)"
                                }
                              ]
                            }
                          ],
                          "rule": [
                            {
                              "name": "r_assign_value",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "title",
                                  "contextType": "variable",
                                  "element": "value",
                                  "transform": "copy",
                                  "parameter": [
                                    {
                                      "valueString": "Newly Diagnosed Client Visit "
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "name": "r_append_visit_number",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "title",
                                  "contextType": "variable",
                                  "element": "value",
                                  "transform": "evaluate",
                                  "parameter": [
                                    {
                                      "valueId": "src"
                                    },
                                    {
                                      "valueString": "title.value + (visit_number.toInteger() + 1).toString()"
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "name": "r_create_care_plan_newly_diagnosed_client",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "dependent": [
                                {
                                  "name": "CreateCarePlan",
                                  "variable": [
                                    "src",
                                    "bundle",
                                    "title"
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_item_create_care_plan_client_already_on_art",
                  "source": [
                    {
                      "context": "item",
                      "condition": "(answer.value.code = 'client-already-on-art')"
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_extract_careplan_title",
                      "source": [
                        {
                          "context": "src",
                          "element": "item",
                          "listMode": "first",
                          "variable": "careplan_title",
                          "condition": "(linkId = 'patient-careplan-title')"
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_extract_visit_number",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "variable": "visit_number",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "careplan_title"
                                },
                                {
                                  "valueString": "$this.answer.value.substring(29, 32)"
                                }
                              ]
                            }
                          ],
                          "rule": [
                            {
                              "name": "r_assign_value",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "title",
                                  "contextType": "variable",
                                  "element": "value",
                                  "transform": "copy",
                                  "parameter": [
                                    {
                                      "valueString": "Client Already On ART Visit "
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "name": "r_append_visit_number",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "title",
                                  "contextType": "variable",
                                  "element": "value",
                                  "transform": "evaluate",
                                  "parameter": [
                                    {
                                      "valueId": "src"
                                    },
                                    {
                                      "valueString": "title.value + (visit_number.toInteger() + 1).toString()"
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "name": "r_create_care_plan_client_already_on_art",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "dependent": [
                                {
                                  "name": "CreateCarePlan",
                                  "variable": [
                                    "src",
                                    "bundle",
                                    "title"
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "AssignCarePlanActivities",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "title",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_assign_exposed_infant_activities",
          "source": [
            {
              "context": "title",
              "element": "value",
              "condition": "($this.contains('Exposed Infant'))"
            }
          ],
          "dependent": [
            {
              "name": "AddExposedInfantCarePlanActivities",
              "variable": [
                "src",
                "carePlan",
                "bundle"
              ]
            }
          ]
        },
        {
          "name": "r_assign_newly_diagnosed_client_activities",
          "source": [
            {
              "context": "title",
              "element": "value",
              "condition": "($this.contains('Newly Diagnosed Client'))"
            }
          ],
          "dependent": [
            {
              "name": "AddNewlyDiagnosedClientCarePlanActivities",
              "variable": [
                "src",
                "carePlan",
                "bundle"
              ]
            }
          ]
        },
        {
          "name": "r_assign_client_already_on_art_activities",
          "source": [
            {
              "context": "title",
              "element": "value",
              "condition": "($this.contains('Client Already On ART'))"
            }
          ],
          "dependent": [
            {
              "name": "AddClientAlreadyOnARTCarePlanActivities",
              "variable": [
                "src",
                "carePlan",
                "bundle"
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "CloseCarePlan",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_check_care_plan_id",
          "source": [
            {
              "context": "src",
              "element": "item",
              "listMode": "first",
              "variable": "item",
              "condition": "(linkId = 'care-plan-id')"
            }
          ],
          "rule": [
            {
              "name": "r_item_care_plan",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "bundle",
                  "contextType": "variable",
                  "element": "entry",
                  "variable": "entry"
                },
                {
                  "context": "entry",
                  "contextType": "variable",
                  "element": "resource",
                  "variable": "carePlan",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "CarePlan"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_item_care_plan_id",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "carePlan",
                      "contextType": "variable",
                      "element": "id",
                      "variable": "carePlan_id",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "id"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_item_care_plan_id_value",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "carePlan_id",
                          "contextType": "variable",
                          "element": "value",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "item"
                            },
                            {
                              "valueString": "$this.answer.value"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_create_string_status",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "variable": "status",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "string"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_string_status_alias",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "status",
                          "contextType": "variable",
                          "element": "value",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "completed"
                            }
                          ]
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_item_care_plan_status",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "carePlan",
                              "contextType": "variable",
                              "element": "status",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "src"
                                },
                                {
                                  "valueString": "status.value"
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_create_care_plan",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "dependent": [
                    {
                      "name": "AssignCarePlan",
                      "variable": [
                        "src",
                        "bundle"
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "CheckIfConversionIsRequired",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "title",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_check_conversion_status",
          "source": [
            {
              "context": "src",
              "element": "item",
              "listMode": "first",
              "variable": "item",
              "condition": "(linkId = 'newly-diagnosed-client-with-viral-load-collection')"
            }
          ],
          "rule": [
            {
              "name": "r_convert_to_ndc",
              "source": [
                {
                  "context": "item",
                  "condition": "($this.answer.value = true)"
                }
              ],
              "dependent": [
                {
                  "name": "UpdatePatient",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle"
                  ]
                }
              ]
            },
            {
              "name": "r_add_to_tracing_list",
              "source": [
                {
                  "context": "item",
                  "condition": "($this.answer.value = false)"
                }
              ],
              "dependent": [
                {
                  "name": "AssignCarePlanActivities",
                  "variable": [
                    "src",
                    "title",
                    "carePlan",
                    "bundle"
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "UpdatePatient",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_check_patient_id",
          "source": [
            {
              "context": "src",
              "element": "item",
              "listMode": "first",
              "variable": "item",
              "condition": "(linkId = 'patient-id')"
            }
          ],
          "rule": [
            {
              "name": "r_create_patient",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "bundle",
                  "contextType": "variable",
                  "element": "entry",
                  "variable": "entry"
                },
                {
                  "context": "entry",
                  "contextType": "variable",
                  "element": "resource",
                  "variable": "patient",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Patient"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_item_patient_id_patient_create_pat_id",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "patient",
                      "contextType": "variable",
                      "element": "id",
                      "variable": "patient_id",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "id"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_item_patient_id_patient_set_pat_id",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "patient_id",
                          "contextType": "variable",
                          "element": "value",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "item"
                            },
                            {
                              "valueString": "$this.answer.value"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_update_patient_cat",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "dependent": [
                    {
                      "name": "UpdatePatientCategory",
                      "variable": [
                        "src",
                        "carePlan",
                        "bundle",
                        "patient"
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "UpdatePatientCategory",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        },
        {
          "name": "patient",
          "type": "Patient",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_patient_meta",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "patient",
              "contextType": "variable",
              "element": "meta",
              "variable": "meta",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "Meta"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_patient_meta_tag",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "meta",
                  "contextType": "variable",
                  "element": "tag",
                  "variable": "coding",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Coding"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_patient_meta_system",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "coding",
                      "contextType": "variable",
                      "element": "system",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "https://d-tree.org"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_patient_meta_code",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "coding",
                      "contextType": "variable",
                      "element": "code",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "client-already-on-art"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_patient_meta_display",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "coding",
                      "contextType": "variable",
                      "element": "display",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "Client Already On ART"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_assign_client_already_on_art_activities",
              "source": [
                {
                  "context": "src"
                }
              ],
              "dependent": [
                {
                  "name": "AddClientAlreadyOnARTCarePlanActivities",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle"
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "CreateCarePlan",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        },
        {
          "name": "title",
          "type": "string",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_cp",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "bundle",
              "contextType": "variable",
              "element": "entry",
              "variable": "entry"
            },
            {
              "context": "entry",
              "contextType": "variable",
              "element": "resource",
              "variable": "carePlan",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "CarePlan"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_cp_data",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "carePlan",
                  "contextType": "variable",
                  "element": "id",
                  "variable": "carePlanId",
                  "transform": "uuid"
                },
                {
                  "context": "carePlan",
                  "contextType": "variable",
                  "element": "title",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "title.value"
                    }
                  ]
                },
                {
                  "context": "carePlan",
                  "contextType": "variable",
                  "element": "status",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "active"
                    }
                  ]
                },
                {
                  "context": "carePlan",
                  "contextType": "variable",
                  "element": "intent",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "plan"
                    }
                  ]
                },
                {
                  "context": "carePlan",
                  "contextType": "variable",
                  "element": "created",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "now()"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_cp_identifier",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "carePlan",
                      "contextType": "variable",
                      "element": "identifier",
                      "variable": "carePlanIdentifier",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Identifier"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_cp_identifier_value",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "carePlanIdentifier",
                          "contextType": "variable",
                          "element": "value",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueId": "carePlanId"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_cp_identifier_use",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "carePlanIdentifier",
                          "contextType": "variable",
                          "element": "use",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "official"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_cp_title",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "carePlan",
                  "contextType": "variable",
                  "element": "subject",
                  "variable": "carePlanSubject",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Reference"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_cp_subject_reference",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "carePlanSubject",
                      "contextType": "variable",
                      "element": "reference",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "'Patient/' + $this.item.where(linkId = 'patient-id').answer.value"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_cp_subject_display",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "carePlanSubject",
                      "contextType": "variable",
                      "element": "display",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "$this.item.where(linkId = 'patient-full-name').answer.value"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_create_next_clinic_visit_datetime",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "variable": "next_clinic_visit",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "dateTime"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_create_str_temp_string",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "variable": "str_temp",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "string"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_extract_date",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "str_temp",
                          "contextType": "variable",
                          "element": "value",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "$this.item.where(linkId = 'date-of-next-appointment').answer.value.toString()"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_append_date_and_time",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "str_temp",
                          "contextType": "variable",
                          "element": "value",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "str_temp.value + 'T11:10:34.227+03:00'"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_assign_str_temp_to_datetime",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "next_clinic_visit",
                          "contextType": "variable",
                          "element": "value",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueId": "str_temp"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_create_period",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "carePlan",
                          "contextType": "variable",
                          "element": "period",
                          "variable": "carePlanPeriod",
                          "transform": "create",
                          "parameter": [
                            {
                              "valueString": "Period"
                            }
                          ]
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_cp_period",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "variable": "current_date_time",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "src"
                                },
                                {
                                  "valueString": "now()"
                                }
                              ]
                            },
                            {
                              "context": "carePlanPeriod",
                              "contextType": "variable",
                              "element": "start",
                              "transform": "copy",
                              "parameter": [
                                {
                                  "valueId": "current_date_time"
                                }
                              ]
                            },
                            {
                              "context": "carePlanPeriod",
                              "contextType": "variable",
                              "element": "end",
                              "transform": "copy",
                              "parameter": [
                                {
                                  "valueId": "next_clinic_visit"
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_cp_author",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "carePlan",
                  "contextType": "variable",
                  "element": "author",
                  "variable": "carePlanAuthor",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Reference"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_practitioner",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "carePlanAuthor",
                      "contextType": "variable",
                      "element": "reference",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "'Practitioner/' + $this.item.where(linkId = 'practitioner-id').answer.value"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_practitioner",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "carePlanAuthor",
                      "contextType": "variable",
                      "element": "display",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "$this.item.where(linkId = 'practitioner-fullname').answer.value"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_add_act_ndc",
              "source": [
                {
                  "context": "src"
                }
              ],
              "dependent": [
                {
                  "name": "CheckIfConversionIsRequired",
                  "variable": [
                    "src",
                    "title",
                    "carePlan",
                    "bundle"
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "AddExposedInfantCarePlanActivities",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_ndc_act_add_acts",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "variable": "taskDescription",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "variable": "taskQuestionnaireId",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "variable": "order",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_task_tb_covid",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "TB/Covid Screening"
                    }
                  ]
                },
                {
                  "context": "taskQuestionnaireId",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "patient-tb-covid"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-2"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "AddCarePlanActivity",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "taskQuestionnaireId",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_order_value_3",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Demographic Updates"
                    }
                  ]
                },
                {
                  "context": "taskQuestionnaireId",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "patient-demographic-updates"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-3"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "AddCarePlanActivity",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "taskQuestionnaireId",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_order_value_4",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Guardian Updates"
                    }
                  ]
                },
                {
                  "context": "taskQuestionnaireId",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "patient-guardian-updates-0-to-15-years"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-4"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "AddCarePlanActivity",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "taskQuestionnaireId",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_order_value_5",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Vitals"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-5"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "PerformVitalsScreening",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_order_value_8",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Counselling"
                    }
                  ]
                },
                {
                  "context": "taskQuestionnaireId",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "exposed-infant-counselling"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-8"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "AddCarePlanActivity",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "taskQuestionnaireId",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_order_value_9",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Medicine"
                    }
                  ]
                },
                {
                  "context": "taskQuestionnaireId",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "exposed-infant-medicine"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-9"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "AddCarePlanActivity",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "taskQuestionnaireId",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_conduct_milestone_hiv_screening_test",
              "source": [
                {
                  "context": "src"
                }
              ],
              "dependent": [
                {
                  "name": "ConductMilestoneHivScreeningTest",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_conduct_exposed_infant_record_hiv_test_result",
              "source": [
                {
                  "context": "src"
                }
              ],
              "dependent": [
                {
                  "name": "ExposedInfantConductRecordHivTestResult",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle"
                  ]
                }
              ]
            }
          ]
        },
        {
          "name": "r_art_tracing_activities",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "variable": "hasPhone",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "boolean"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_extract_tracing",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "hasPhone",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "($this.item.where(linkId = 'patient-has-phone').exists() and $this.item.where(linkId = 'patient-has-phone').answer.value).toString()"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "AddExposedInfantCarePlanTracingActivities",
                  "variable": [
                    "src",
                    "hasPhone",
                    "carePlan",
                    "bundle"
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "ConductMilestoneHivScreeningTest",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        },
        {
          "name": "taskDescription",
          "type": "string",
          "mode": "target"
        },
        {
          "name": "order",
          "type": "string",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_check_milestone_hiv_screening_test",
          "source": [
            {
              "context": "src",
              "element": "item",
              "listMode": "first",
              "variable": "item",
              "condition": "(linkId = 'conduct-milestone-hiv-screening-test')"
            }
          ],
          "rule": [
            {
              "name": "r_add_milestone_hiv_screening_test",
              "source": [
                {
                  "context": "item",
                  "condition": "($this.answer.value = 'true')"
                }
              ],
              "rule": [
                {
                  "name": "r_order_value_7",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "taskDescription",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "Milestone HIV test"
                        }
                      ]
                    },
                    {
                      "context": "order",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "clinic-visit-task-order-7"
                        }
                      ]
                    }
                  ],
                  "dependent": [
                    {
                      "name": "PerformMilestoneHIVTestScreening",
                      "variable": [
                        "src",
                        "carePlan",
                        "bundle",
                        "taskDescription",
                        "order"
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "ExposedInfantConductRecordHivTestResult",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_check_conduct_exposed_infant_record_hiv_test_result",
          "source": [
            {
              "context": "src",
              "condition": "($this.item.where(linkId = 'conduct-exposed-infant-record-hiv-test-result').answer.value = true)"
            }
          ],
          "rule": [
            {
              "name": "r_add_exposed_infant_record_hiv_test_result",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "variable": "taskDescription",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "string"
                    }
                  ]
                },
                {
                  "variable": "taskQuestionnaireId",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "string"
                    }
                  ]
                },
                {
                  "variable": "order",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "string"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_task_tb_covid",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "taskDescription",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "Record HIV Test Results"
                        }
                      ]
                    },
                    {
                      "context": "taskQuestionnaireId",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "exposed-infant-record-hiv-test-results"
                        }
                      ]
                    },
                    {
                      "context": "order",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "clinic-visit-task-order-8"
                        }
                      ]
                    }
                  ],
                  "dependent": [
                    {
                      "name": "AddCarePlanActivity",
                      "variable": [
                        "src",
                        "carePlan",
                        "bundle",
                        "taskDescription",
                        "taskQuestionnaireId",
                        "order"
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "AddNewlyDiagnosedClientCarePlanSecondVisitActivities",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_extract_careplan_title",
          "source": [
            {
              "context": "src",
              "element": "item",
              "listMode": "first",
              "variable": "item",
              "condition": "((linkId = 'patient-careplan-title') and (answer.value = 'Newly Diagnosed Client Visit 1'))"
            }
          ],
          "rule": [
            {
              "name": "r_extract_careplan_visit_number",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "variable": "visit_number",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "item"
                    },
                    {
                      "valueString": "$this.answer.value.substring(29, 32)"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_run_if_careplan_visit_number_is_one",
                  "source": [
                    {
                      "context": "src",
                      "condition": "(visit_number = '1')"
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_ndc_act_add_acts",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "variable": "taskDescription",
                          "transform": "create",
                          "parameter": [
                            {
                              "valueString": "string"
                            }
                          ]
                        },
                        {
                          "variable": "taskQuestionnaireId",
                          "transform": "create",
                          "parameter": [
                            {
                              "valueString": "string"
                            }
                          ]
                        },
                        {
                          "variable": "order",
                          "transform": "create",
                          "parameter": [
                            {
                              "valueString": "string"
                            }
                          ]
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_task_tb_covid",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "taskDescription",
                              "contextType": "variable",
                              "element": "value",
                              "transform": "copy",
                              "parameter": [
                                {
                                  "valueString": "Welcome Service"
                                }
                              ]
                            },
                            {
                              "context": "taskQuestionnaireId",
                              "contextType": "variable",
                              "element": "value",
                              "transform": "copy",
                              "parameter": [
                                {
                                  "valueString": "art-client-welcome-service-newly-diagnosed"
                                }
                              ]
                            },
                            {
                              "context": "order",
                              "contextType": "variable",
                              "element": "value",
                              "transform": "copy",
                              "parameter": [
                                {
                                  "valueString": "clinic-visit-task-order-10"
                                }
                              ]
                            }
                          ],
                          "dependent": [
                            {
                              "name": "AddCarePlanActivity",
                              "variable": [
                                "src",
                                "carePlan",
                                "bundle",
                                "taskDescription",
                                "taskQuestionnaireId",
                                "order"
                              ]
                            }
                          ]
                        },
                        {
                          "name": "r_task_tb_covid",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "taskDescription",
                              "contextType": "variable",
                              "element": "value",
                              "transform": "copy",
                              "parameter": [
                                {
                                  "valueString": "Index Case Testing"
                                }
                              ]
                            },
                            {
                              "context": "taskQuestionnaireId",
                              "contextType": "variable",
                              "element": "value",
                              "transform": "copy",
                              "parameter": [
                                {
                                  "valueString": "art-client-index-case-testing"
                                }
                              ]
                            },
                            {
                              "context": "order",
                              "contextType": "variable",
                              "element": "value",
                              "transform": "copy",
                              "parameter": [
                                {
                                  "valueString": "clinic-visit-task-order-7"
                                }
                              ]
                            }
                          ],
                          "dependent": [
                            {
                              "name": "AddCarePlanActivity",
                              "variable": [
                                "src",
                                "carePlan",
                                "bundle",
                                "taskDescription",
                                "taskQuestionnaireId",
                                "order"
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "AddNewlyDiagnosedClientCarePlanActivities",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_ndc_act_add_acts",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "variable": "taskDescription",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "variable": "taskQuestionnaireId",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "variable": "order",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_task_tb_covid",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "TB/Covid Screening"
                    }
                  ]
                },
                {
                  "context": "taskQuestionnaireId",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "patient-tb-covid"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-2"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "AddCarePlanActivity",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "taskQuestionnaireId",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_order_value_2",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Demographic Updates"
                    }
                  ]
                },
                {
                  "context": "taskQuestionnaireId",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "patient-demographic-updates"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-3"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "AddCarePlanActivity",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "taskQuestionnaireId",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_order_value_3",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Guardian Updates"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-4"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "PerformGuardianUpdatesScreening",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_order_value_4",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Vitals"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-5"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "PerformVitalsScreening",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_order_value_4",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Women's Health Screening"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-6"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "PerformWomensHealthScreeningScreening",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_order_value_16",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "TB History and Regimen"
                    }
                  ]
                },
                {
                  "context": "taskQuestionnaireId",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "art-client-tb-history-and-regimen"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-16"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "AddCarePlanActivity",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "taskQuestionnaireId",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_newlydiagnosedclient_careplan_secondvisit",
              "source": [
                {
                  "context": "src"
                }
              ],
              "dependent": [
                {
                  "name": "AddNewlyDiagnosedClientCarePlanSecondVisitActivities",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle"
                  ]
                }
              ]
            }
          ]
        },
        {
          "name": "r_art_tracing_activities",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "variable": "hasPhone",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "boolean"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_extract_tracing",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "hasPhone",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "($this.item.where(linkId = 'patient-has-phone').exists() and $this.item.where(linkId = 'patient-has-phone').answer.value).toString()"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "AddARTClientCarePlanTracingActivities",
                  "variable": [
                    "src",
                    "hasPhone",
                    "bundle",
                    "carePlan"
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "AddClientAlreadyOnARTCarePlanActivities",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_ndc_act_add_acts",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "variable": "taskDescription",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "variable": "taskQuestionnaireId",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "variable": "order",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_task_screening",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Screening"
                    }
                  ]
                },
                {
                  "context": "taskQuestionnaireId",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "patient-screening"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-1"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "AddCarePlanActivity",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "taskQuestionnaireId",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_task_tb_covid",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "TB/Covid Screening"
                    }
                  ]
                },
                {
                  "context": "taskQuestionnaireId",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "patient-tb-covid"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-2"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "AddCarePlanActivity",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "taskQuestionnaireId",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_order_value_2",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Demographic Updates"
                    }
                  ]
                },
                {
                  "context": "taskQuestionnaireId",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "patient-demographic-updates"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-3"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "AddCarePlanActivity",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "taskQuestionnaireId",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_order_value_3",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Guardian Updates"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-4"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "PerformGuardianUpdatesScreening",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_order_value_4",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Vitals"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-5"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "PerformVitalsScreening",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_order_value_4",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Women's Health Screening"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-6"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "PerformWomensHealthScreeningScreening",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "order"
                  ]
                }
              ]
            },
            {
              "name": "r_order_value_9",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "taskDescription",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "TB History and Regimen"
                    }
                  ]
                },
                {
                  "context": "taskQuestionnaireId",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "art-client-tb-history-and-regimen"
                    }
                  ]
                },
                {
                  "context": "order",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "clinic-visit-task-order-16"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "AddCarePlanActivity",
                  "variable": [
                    "src",
                    "carePlan",
                    "bundle",
                    "taskDescription",
                    "taskQuestionnaireId",
                    "order"
                  ]
                }
              ]
            }
          ]
        },
        {
          "name": "r_art_tracing_activities",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "variable": "hasPhone",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "boolean"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_extract_tracing",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "hasPhone",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "($this.item.where(linkId = 'patient-has-phone').exists() and $this.item.where(linkId = 'patient-has-phone').answer.value).toString()"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "AddARTClientCarePlanTracingActivities",
                  "variable": [
                    "src",
                    "hasPhone",
                    "bundle",
                    "carePlan"
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "AddCarePlanActivity",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        },
        {
          "name": "taskDescription",
          "type": "string",
          "mode": "target"
        },
        {
          "name": "taskQuestionnaireId",
          "type": "string",
          "mode": "target"
        },
        {
          "name": "order",
          "type": "string",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_act",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "carePlan",
              "contextType": "variable",
              "element": "activity",
              "variable": "activity",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "CarePlan_Activity"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_act_det",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "activity",
                  "contextType": "variable",
                  "element": "detail",
                  "variable": "detail",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "CarePlan_ActivityDetail"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_act_det_data",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "detail",
                      "contextType": "variable",
                      "element": "kind",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "Task"
                        }
                      ]
                    },
                    {
                      "context": "detail",
                      "contextType": "variable",
                      "element": "status",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "in-progress"
                        }
                      ]
                    },
                    {
                      "context": "detail",
                      "contextType": "variable",
                      "element": "description",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "taskDescription"
                        },
                        {
                          "valueString": "$this.value"
                        }
                      ]
                    },
                    {
                      "context": "detail",
                      "contextType": "variable",
                      "element": "code",
                      "transform": "cc",
                      "parameter": [
                        {
                          "valueString": "https://d-tree.org"
                        },
                        {
                          "valueId": "taskQuestionnaireId"
                        },
                        {
                          "valueId": "taskDescription"
                        }
                      ]
                    },
                    {
                      "context": "detail",
                      "contextType": "variable",
                      "element": "scheduled",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "carePlan"
                        },
                        {
                          "valueString": "$this.period"
                        }
                      ]
                    },
                    {
                      "context": "detail",
                      "contextType": "variable",
                      "element": "performer",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "carePlan"
                        },
                        {
                          "valueString": "$this.author"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_create_task_id",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "variable": "taskId",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "string"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_set_task_id",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "taskId",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "uuid"
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_act_outcome_reference",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "activity",
                          "contextType": "variable",
                          "element": "outcomeReference",
                          "variable": "activityOutcomeRef",
                          "transform": "create",
                          "parameter": [
                            {
                              "valueString": "Reference"
                            }
                          ]
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_act_outcome_reference_ref",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "activityOutcomeRef",
                              "contextType": "variable",
                              "element": "reference",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "taskId"
                                },
                                {
                                  "valueString": "'Task/' + $this.value"
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "name": "r_act_outcome_reference_display",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "activityOutcomeRef",
                              "contextType": "variable",
                              "element": "display",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "taskDescription"
                                },
                                {
                                  "valueString": "$this.value"
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "name": "r_create_task_uuid",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "dependent": [
                            {
                              "name": "ExtractTask",
                              "variable": [
                                "src",
                                "carePlan",
                                "bundle",
                                "taskId",
                                "taskDescription",
                                "taskQuestionnaireId",
                                "order"
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "ExtractTask",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        },
        {
          "name": "taskId",
          "type": "string",
          "mode": "target"
        },
        {
          "name": "taskDescription",
          "type": "string",
          "mode": "target"
        },
        {
          "name": "taskQuestionnaireId",
          "type": "string",
          "mode": "target"
        },
        {
          "name": "order",
          "type": "string",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_create_task",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "bundle",
              "contextType": "variable",
              "element": "entry",
              "variable": "entry"
            },
            {
              "context": "entry",
              "contextType": "variable",
              "element": "resource",
              "variable": "task",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "Task"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_task_data",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "status",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "ready"
                    }
                  ]
                },
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "intent",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "plan"
                    }
                  ]
                },
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "priority",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "routine"
                    }
                  ]
                },
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "description",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "taskDescription"
                    },
                    {
                      "valueString": "$this.value"
                    }
                  ]
                },
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "authoredOn",
                  "variable": "current_date_time",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "now()"
                    }
                  ]
                },
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "lastModified",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueId": "current_date_time"
                    }
                  ]
                },
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "for",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "carePlan"
                    },
                    {
                      "valueString": "$this.subject"
                    }
                  ]
                },
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "executionPeriod",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "carePlan"
                    },
                    {
                      "valueString": "$this.period"
                    }
                  ]
                },
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "requester",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "carePlan"
                    },
                    {
                      "valueString": "$this.author"
                    }
                  ]
                },
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "owner",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "carePlan"
                    },
                    {
                      "valueString": "$this.author"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_task_identifier",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "task",
                      "contextType": "variable",
                      "element": "identifier",
                      "variable": "taskIdentifier",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Identifier"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_task_identifier_value",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "taskIdentifier",
                          "contextType": "variable",
                          "element": "value",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueId": "taskId"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_task_identifier_use",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "taskIdentifier",
                          "contextType": "variable",
                          "element": "use",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "official"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_create_id",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "variable": "task_id",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "id"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_set_task_id_value",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "task_id",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueId": "taskId"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_set_task_id",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "task",
                      "contextType": "variable",
                      "element": "id",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueId": "task_id"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_task_meta",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "meta",
                  "variable": "meta",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Meta"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_task_meta_tag",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "meta",
                      "contextType": "variable",
                      "element": "tag",
                      "transform": "c",
                      "parameter": [
                        {
                          "valueString": "https://d-tree.org"
                        },
                        {
                          "valueId": "order"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_task_reason_reference",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "reasonReference",
                  "variable": "taskReasonRef",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Reference"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_task_reason_reference_ref",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "taskReasonRef",
                      "contextType": "variable",
                      "element": "reference",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "taskQuestionnaireId"
                        },
                        {
                          "valueString": "'Questionnaire/' + $this.value"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_task_reason_reference_display",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "taskReasonRef",
                      "contextType": "variable",
                      "element": "display",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "taskDescription"
                        },
                        {
                          "valueString": "$this.value"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "PerformVitalsScreening",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        },
        {
          "name": "taskDescription",
          "type": "string",
          "mode": "target"
        },
        {
          "name": "order",
          "type": "string",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_patient_birth_date",
          "source": [
            {
              "context": "src",
              "element": "item",
              "listMode": "first",
              "variable": "birthDateItem",
              "condition": "(linkId = 'patient-birth-date')"
            }
          ],
          "rule": [
            {
              "name": "r_patient_gender",
              "source": [
                {
                  "context": "src",
                  "element": "item",
                  "listMode": "first",
                  "variable": "genderItem",
                  "condition": "(linkId = 'patient-gender')"
                }
              ],
              "rule": [
                {
                  "name": "r_create_string_questionnaire_id",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "variable": "taskQuestionnaireId",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "string"
                        }
                      ]
                    },
                    {
                      "variable": "birthDate",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "birthDateItem"
                        },
                        {
                          "valueString": "$this.answer.value"
                        }
                      ]
                    },
                    {
                      "variable": "gender",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "genderItem"
                        },
                        {
                          "valueString": "$this.answer.value.code"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_ndc_date_ranges",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "variable": "date_6_months_ago",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "(today() - ((6 * 30).toString() + ' days').toQuantity())"
                            }
                          ]
                        },
                        {
                          "variable": "date_15_years_ago",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "(today() - ((15 * 365).toString() + ' days').toQuantity())"
                            }
                          ]
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_ndc_gender_male",
                          "source": [
                            {
                              "context": "src",
                              "condition": "(gender = 'male')"
                            }
                          ],
                          "rule": [
                            {
                              "name": "r_vitals_male_0_to_6_months",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "taskQuestionnaireId",
                                  "contextType": "variable",
                                  "element": "value",
                                  "transform": "evaluate",
                                  "parameter": [
                                    {
                                      "valueId": "src"
                                    },
                                    {
                                      "valueString": "iif(birthDate >= date_6_months_ago, 'patient-vitals-male-0-to-6-months')"
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "name": "r_vitals_6_months_to_5_years",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "taskQuestionnaireId",
                                  "contextType": "variable",
                                  "element": "value",
                                  "transform": "evaluate",
                                  "parameter": [
                                    {
                                      "valueId": "src"
                                    },
                                    {
                                      "valueString": "iif((birthDate >= date_15_years_ago) and (birthDate < date_6_months_ago), 'patient-vitals-6-months-to-15-years')"
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "name": "r_vitals_male_15_years_plus",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "taskQuestionnaireId",
                                  "contextType": "variable",
                                  "element": "value",
                                  "transform": "evaluate",
                                  "parameter": [
                                    {
                                      "valueId": "src"
                                    },
                                    {
                                      "valueString": "iif(birthDate < date_15_years_ago, 'art-client-vitals-male-15-years-plus')"
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "name": "r_ndc_gender_female",
                          "source": [
                            {
                              "context": "src",
                              "condition": "(gender = 'female')"
                            }
                          ],
                          "rule": [
                            {
                              "name": "r_vitals_female_0_to_6_months",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "taskQuestionnaireId",
                                  "contextType": "variable",
                                  "element": "value",
                                  "transform": "evaluate",
                                  "parameter": [
                                    {
                                      "valueId": "src"
                                    },
                                    {
                                      "valueString": "iif(birthDate >= date_6_months_ago, 'patient-vitals-female-0-to-6-months')"
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "name": "r_vitals_6_months_to_5_years",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "taskQuestionnaireId",
                                  "contextType": "variable",
                                  "element": "value",
                                  "transform": "evaluate",
                                  "parameter": [
                                    {
                                      "valueId": "src"
                                    },
                                    {
                                      "valueString": "iif((birthDate >= date_15_years_ago) and (birthDate < date_6_months_ago), 'patient-vitals-6-months-to-15-years')"
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "name": "r_vitals_female_15_years_plus",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "taskQuestionnaireId",
                                  "contextType": "variable",
                                  "element": "value",
                                  "transform": "evaluate",
                                  "parameter": [
                                    {
                                      "valueId": "src"
                                    },
                                    {
                                      "valueString": "iif(birthDate < date_15_years_ago, 'art-client-vitals-female-15-years-plus')"
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "name": "r_add_vitals_activity",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "dependent": [
                            {
                              "name": "AddCarePlanActivity",
                              "variable": [
                                "src",
                                "carePlan",
                                "bundle",
                                "taskDescription",
                                "taskQuestionnaireId",
                                "order"
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "PerformMilestoneHIVTestScreening",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        },
        {
          "name": "taskDescription",
          "type": "string",
          "mode": "target"
        },
        {
          "name": "order",
          "type": "string",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_milestone_hiv_extract_birthdate_item",
          "source": [
            {
              "context": "src",
              "element": "item",
              "listMode": "first",
              "variable": "birthDateItem",
              "condition": "(linkId = 'patient-birth-date')"
            }
          ],
          "rule": [
            {
              "name": "r_milestone_hiv_check_bithdate",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "variable": "taskQuestionnaireId",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "string"
                    }
                  ]
                },
                {
                  "variable": "six_weeks",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "string"
                    }
                  ]
                },
                {
                  "variable": "eight_weeks",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "string"
                    }
                  ]
                },
                {
                  "variable": "fifty_weeks",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "string"
                    }
                  ]
                },
                {
                  "variable": "fityfour_weeks",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "string"
                    }
                  ]
                },
                {
                  "variable": "onehundred_weeks",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "string"
                    }
                  ]
                },
                {
                  "variable": "birthDate",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "birthDateItem"
                    },
                    {
                      "valueString": "$this.answer.value"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_milestone_hiv_check_date_ranges",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "six_weeks",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "6 weeks"
                        }
                      ]
                    },
                    {
                      "context": "eight_weeks",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "8 weeks"
                        }
                      ]
                    },
                    {
                      "context": "fifty_weeks",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "50 weeks"
                        }
                      ]
                    },
                    {
                      "context": "fityfour_weeks",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "54 weeks"
                        }
                      ]
                    },
                    {
                      "context": "onehundred_weeks",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "100 weeks"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_check_next_appointment",
                      "source": [
                        {
                          "context": "src",
                          "element": "item",
                          "listMode": "first",
                          "variable": "item",
                          "condition": "(linkId = 'date-of-next-appointment')"
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_check_next_appointment_date",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "variable": "next_appointment_date",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "item"
                                },
                                {
                                  "valueString": "$this.answer.value"
                                }
                              ]
                            }
                          ],
                          "rule": [
                            {
                              "name": "r_check_within_range",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "variable": "six_to_8_weeks_range",
                                  "transform": "evaluate",
                                  "parameter": [
                                    {
                                      "valueId": "src"
                                    },
                                    {
                                      "valueString": "((next_appointment_date - six_weeks.toQuantity()) >= birthDate) and ((next_appointment_date - eight_weeks.toQuantity()) <= birthDate)"
                                    }
                                  ]
                                },
                                {
                                  "variable": "fifty_to_55_weeks_range",
                                  "transform": "evaluate",
                                  "parameter": [
                                    {
                                      "valueId": "src"
                                    },
                                    {
                                      "valueString": "((next_appointment_date - fifty_weeks.toQuantity()) >= birthDate) and ((next_appointment_date - fityfour_weeks.toQuantity()) <= birthDate)"
                                    }
                                  ]
                                },
                                {
                                  "variable": "onehundred_weeks",
                                  "transform": "evaluate",
                                  "parameter": [
                                    {
                                      "valueId": "src"
                                    },
                                    {
                                      "valueString": "(next_appointment_date - onehundred_weeks.toQuantity()) >= birthDate"
                                    }
                                  ]
                                }
                              ],
                              "rule": [
                                {
                                  "name": "r_within_range",
                                  "source": [
                                    {
                                      "context": "src",
                                      "condition": "((six_to_8_weeks_range = 'true') or (fifty_to_55_weeks_range = 'true') or (onehundred_weeks = 'true'))"
                                    }
                                  ],
                                  "rule": [
                                    {
                                      "name": "r_task_questionnaire_id",
                                      "source": [
                                        {
                                          "context": "src"
                                        }
                                      ],
                                      "target": [
                                        {
                                          "context": "taskQuestionnaireId",
                                          "contextType": "variable",
                                          "element": "value",
                                          "transform": "copy",
                                          "parameter": [
                                            {
                                              "valueString": "Questionnaire/exposed-infant-milestone-hiv-test"
                                            }
                                          ]
                                        }
                                      ]
                                    },
                                    {
                                      "name": "r_add_vitals_activity_milestone_hiv",
                                      "source": [
                                        {
                                          "context": "src"
                                        }
                                      ],
                                      "dependent": [
                                        {
                                          "name": "AddCarePlanActivity",
                                          "variable": [
                                            "src",
                                            "carePlan",
                                            "bundle",
                                            "taskDescription",
                                            "taskQuestionnaireId",
                                            "order"
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "PerformCounsellingScreening",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        },
        {
          "name": "taskDescription",
          "type": "string",
          "mode": "target"
        },
        {
          "name": "order",
          "type": "string",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_counselling_extract_birthdate_item",
          "source": [
            {
              "context": "src",
              "element": "item",
              "listMode": "first",
              "variable": "birthDateItem",
              "condition": "(linkId = 'patient-birth-date')"
            }
          ],
          "rule": [
            {
              "name": "r_counselling_check_bithdate",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "variable": "taskQuestionnaireId",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "string"
                    }
                  ]
                },
                {
                  "variable": "birthDate",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "birthDateItem"
                    },
                    {
                      "valueString": "$this.answer.value"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_counselling_check_date_ranges",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "variable": "date_6_weeks_ago",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "(today() - ((6 * 7).toString() + ' days').toQuantity())"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_exposed_infant_counselling_questionnaire_id",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "taskQuestionnaireId",
                          "contextType": "variable",
                          "element": "value",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "Questionnaire/exposed-infant-counselling"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_add_vitals_activity",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "dependent": [
                        {
                          "name": "AddCarePlanActivity",
                          "variable": [
                            "src",
                            "carePlan",
                            "bundle",
                            "taskDescription",
                            "taskQuestionnaireId",
                            "order"
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "PerformWomensHealthScreeningScreening",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        },
        {
          "name": "taskDescription",
          "type": "string",
          "mode": "target"
        },
        {
          "name": "order",
          "type": "string",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_check_gender",
          "source": [
            {
              "context": "src",
              "element": "item",
              "variable": "item",
              "condition": "((linkId = 'patient-gender') and (answer.value.code = 'female'))"
            }
          ],
          "rule": [
            {
              "name": "r_dob",
              "source": [
                {
                  "context": "src",
                  "element": "item",
                  "variable": "birthDate",
                  "condition": "(linkId = 'patient-birth-date')"
                }
              ],
              "rule": [
                {
                  "name": "r_ndc_whs_patient_birth_date",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "variable": "taskQuestionnaireId",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "string"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_ndc_date_ranges",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "variable": "date_9_years_ago",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "(today() - ((9 * 365).toString() + ' days').toQuantity())"
                            }
                          ]
                        },
                        {
                          "variable": "date_14_years_ago",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "(today() - ((14 * 365).toString() + ' days').toQuantity())"
                            }
                          ]
                        },
                        {
                          "variable": "date_15_years_ago",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "(today() - ((15 * 365).toString() + ' days').toQuantity())"
                            }
                          ]
                        },
                        {
                          "variable": "date_25_years_ago",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "(today() - ((25 * 365).toString() + ' days').toQuantity())"
                            }
                          ]
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_check_range",
                          "source": [
                            {
                              "context": "birthDate",
                              "condition": "((($this >= date_14_years_ago) and ($this <= date_9_years_ago)) or ($this <= date_15_years_ago))"
                            }
                          ],
                          "rule": [
                            {
                              "name": "r_whs_9_to_14_years",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "taskQuestionnaireId",
                                  "contextType": "variable",
                                  "element": "value",
                                  "transform": "evaluate",
                                  "parameter": [
                                    {
                                      "valueId": "src"
                                    },
                                    {
                                      "valueString": "iif((birthDate >= date_14_years_ago) and (birthDate <= date_9_years_ago), 'Questionnaire/art-client-womens-health-screening-female-9-to-14-years')"
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "name": "r_whs_15_to_25_years",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "taskQuestionnaireId",
                                  "contextType": "variable",
                                  "element": "value",
                                  "transform": "evaluate",
                                  "parameter": [
                                    {
                                      "valueId": "src"
                                    },
                                    {
                                      "valueString": "iif((birthDate >= date_25_years_ago) and (birthDate <= date_15_years_ago), 'Questionnaire/art-client-womens-health-screening-female-15-to-25-years')"
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "name": "r_whs_25_years_plus",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "target": [
                                {
                                  "context": "taskQuestionnaireId",
                                  "contextType": "variable",
                                  "element": "value",
                                  "transform": "evaluate",
                                  "parameter": [
                                    {
                                      "valueId": "src"
                                    },
                                    {
                                      "valueString": "iif(birthDate < date_25_years_ago, 'Questionnaire/art-client-womens-health-screening-female-25-years-plus')"
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "name": "r_add_whs-act",
                              "source": [
                                {
                                  "context": "src"
                                }
                              ],
                              "dependent": [
                                {
                                  "name": "AddCarePlanActivity",
                                  "variable": [
                                    "src",
                                    "carePlan",
                                    "bundle",
                                    "taskDescription",
                                    "taskQuestionnaireId",
                                    "order"
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "PerformGuardianUpdatesScreening",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        },
        {
          "name": "taskDescription",
          "type": "string",
          "mode": "target"
        },
        {
          "name": "order",
          "type": "string",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_date_of_birth",
          "source": [
            {
              "context": "src",
              "element": "item",
              "listMode": "first",
              "variable": "birthDate",
              "condition": "(linkId = 'patient-birth-date')"
            }
          ],
          "rule": [
            {
              "name": "r_guardian_updates_screening",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "variable": "taskQuestionnaireId",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "string"
                    }
                  ]
                },
                {
                  "variable": "date_15_years_ago",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "(today() - ((15 * 365).toString() + ' days').toQuantity())"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_guardian_updates_add_activity",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "taskQuestionnaireId",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "iif(birthDate >= date_15_years_ago, 'Questionnaire/patient-guardian-updates-0-to-15-years', 'Questionnaire/patient-guardian-updates-15-years-plus')"
                        }
                      ]
                    }
                  ],
                  "dependent": [
                    {
                      "name": "AddCarePlanActivity",
                      "variable": [
                        "src",
                        "carePlan",
                        "bundle",
                        "taskDescription",
                        "taskQuestionnaireId",
                        "order"
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "AddARTClientCarePlanTracingActivities",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "hasPhone",
          "type": "boolean",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_appointment_date",
          "source": [
            {
              "context": "src",
              "element": "item",
              "variable": "appointmentDateItem",
              "condition": "(linkId = 'date-of-next-appointment')"
            }
          ],
          "target": [
            {
              "variable": "appointmentDate",
              "transform": "evaluate",
              "parameter": [
                {
                  "valueId": "appointmentDateItem"
                },
                {
                  "valueString": "$this.answer.value"
                }
              ]
            },
            {
              "variable": "reasonCode",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "variable": "reasonDisplay",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "variable": "reasonText",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "variable": "questionnaireId",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "variable": "schedulePeriod",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "Period"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_interrupted_treatment_activity",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "reasonCode",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "interrupt-treat"
                    }
                  ]
                },
                {
                  "context": "reasonDisplay",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Interrupted Treatment"
                    }
                  ]
                },
                {
                  "context": "reasonText",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Interrupt Treat"
                    }
                  ]
                },
                {
                  "context": "questionnaireId",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "art-tracing-outcome"
                    }
                  ]
                },
                {
                  "variable": "startDate",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "dateTime"
                    }
                  ]
                },
                {
                  "context": "startDate",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "(appointmentDate + ('28 days').toQuantity()).toString() + 'T00:00:00+00:00'"
                    }
                  ]
                },
                {
                  "context": "schedulePeriod",
                  "contextType": "variable",
                  "element": "start",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueId": "startDate"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "AddTracingActivity",
                  "variable": [
                    "src",
                    "reasonCode",
                    "reasonDisplay",
                    "reasonText",
                    "hasPhone",
                    "questionnaireId",
                    "schedulePeriod",
                    "carePlan",
                    "bundle"
                  ]
                }
              ]
            },
            {
              "name": "r_missed_appointment_activity",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "reasonCode",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "miss-appt"
                    }
                  ]
                },
                {
                  "context": "reasonDisplay",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Missed Appointment"
                    }
                  ]
                },
                {
                  "context": "reasonText",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "Miss Appt"
                    }
                  ]
                },
                {
                  "context": "questionnaireId",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "art-tracing-outcome"
                    }
                  ]
                },
                {
                  "variable": "startDate",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "dateTime"
                    }
                  ]
                },
                {
                  "variable": "endDate",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "dateTime"
                    }
                  ]
                },
                {
                  "context": "startDate",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "(appointmentDate + ('7 days').toQuantity()).toString() + 'T00:00:00+00:00'"
                    }
                  ]
                },
                {
                  "context": "endDate",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "(appointmentDate + ('27 days').toQuantity()).toString() + 'T00:00:00+00:00'"
                    }
                  ]
                },
                {
                  "context": "schedulePeriod",
                  "contextType": "variable",
                  "element": "start",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueId": "startDate"
                    }
                  ]
                },
                {
                  "context": "schedulePeriod",
                  "contextType": "variable",
                  "element": "end",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueId": "endDate"
                    }
                  ]
                }
              ],
              "dependent": [
                {
                  "name": "AddTracingActivity",
                  "variable": [
                    "src",
                    "reasonCode",
                    "reasonDisplay",
                    "reasonText",
                    "hasPhone",
                    "questionnaireId",
                    "schedulePeriod",
                    "carePlan",
                    "bundle"
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "AddExposedInfantCarePlanTracingActivities",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "hasPhone",
          "type": "boolean",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_milestone_tracings",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "variable": "tracker",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "boolean"
                }
              ]
            },
            {
              "context": "tracker",
              "contextType": "variable",
              "element": "value",
              "transform": "copy",
              "parameter": [
                {
                  "valueString": "false"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_has_milestone_task",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "tracker",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "(carePlan.activity.where(outcomeReference.display = 'Milestone HIV test').exists()).toString()"
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_extract_routine_milestone",
              "source": [
                {
                  "context": "src"
                }
              ],
              "dependent": [
                {
                  "name": "ExtractMissedRoutineAndMilestoneTracing",
                  "variable": [
                    "src",
                    "hasPhone",
                    "tracker",
                    "carePlan",
                    "bundle"
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "ExtractMissedRoutineAndMilestoneTracing",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "hasPhone",
          "type": "boolean",
          "mode": "source"
        },
        {
          "name": "hasMilestone",
          "type": "boolean",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_appointment_date",
          "source": [
            {
              "context": "src",
              "element": "item",
              "variable": "appointmentDateItem",
              "condition": "(linkId = 'date-of-next-appointment')"
            }
          ],
          "target": [
            {
              "variable": "appointmentDate",
              "transform": "evaluate",
              "parameter": [
                {
                  "valueId": "appointmentDateItem"
                },
                {
                  "valueString": "$this.answer.value"
                }
              ]
            },
            {
              "variable": "reasonCode",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "variable": "reasonDisplay",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "variable": "reasonText",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "variable": "questionnaireId",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "variable": "schedulePeriod",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "Period"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_miss_milestone_activity",
              "source": [
                {
                  "context": "hasMilestone",
                  "condition": "$this = true"
                }
              ],
              "rule": [
                {
                  "name": "r_miss_milestone_activity_1",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "reasonCode",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "miss-milestone"
                        }
                      ]
                    },
                    {
                      "context": "reasonDisplay",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "Missed Milestone Visit"
                        }
                      ]
                    },
                    {
                      "context": "reasonText",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "Miss Milestone"
                        }
                      ]
                    },
                    {
                      "context": "questionnaireId",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "art-tracing-outcome"
                        }
                      ]
                    },
                    {
                      "variable": "startDate",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "dateTime"
                        }
                      ]
                    },
                    {
                      "context": "startDate",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "(appointmentDate + ('1 day').toQuantity()).toString() + 'T00:00:00+00:00'"
                        }
                      ]
                    },
                    {
                      "context": "schedulePeriod",
                      "contextType": "variable",
                      "element": "start",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueId": "startDate"
                        }
                      ]
                    }
                  ],
                  "dependent": [
                    {
                      "name": "AddTracingActivity",
                      "variable": [
                        "src",
                        "reasonCode",
                        "reasonDisplay",
                        "reasonText",
                        "hasPhone",
                        "questionnaireId",
                        "schedulePeriod",
                        "carePlan",
                        "bundle"
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_no_milestone_activity",
              "source": [
                {
                  "context": "hasMilestone",
                  "condition": "$this = false"
                }
              ],
              "rule": [
                {
                  "name": "r_missed_appointment_activity",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "reasonCode",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "miss-routine"
                        }
                      ]
                    },
                    {
                      "context": "reasonDisplay",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "Missed Routine Visit"
                        }
                      ]
                    },
                    {
                      "context": "reasonText",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "Miss Routine"
                        }
                      ]
                    },
                    {
                      "context": "questionnaireId",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "art-tracing-outcome"
                        }
                      ]
                    },
                    {
                      "variable": "startDate",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "dateTime"
                        }
                      ]
                    },
                    {
                      "context": "startDate",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "(appointmentDate + ('7 days').toQuantity()).toString() + 'T00:00:00+00:00'"
                        }
                      ]
                    },
                    {
                      "context": "schedulePeriod",
                      "contextType": "variable",
                      "element": "start",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueId": "startDate"
                        }
                      ]
                    }
                  ],
                  "dependent": [
                    {
                      "name": "AddTracingActivity",
                      "variable": [
                        "src",
                        "reasonCode",
                        "reasonDisplay",
                        "reasonText",
                        "hasPhone",
                        "questionnaireId",
                        "schedulePeriod",
                        "carePlan",
                        "bundle"
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "AddTracingActivity",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "reasonCode",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "reasonDisplay",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "reasonText",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "hasPhone",
          "type": "boolean",
          "mode": "source"
        },
        {
          "name": "outcomeQuestionnaireId",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "schedulePeriod",
          "type": "Period",
          "mode": "source"
        },
        {
          "name": "carePlan",
          "type": "CarePlan",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_act_linkage",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "carePlan",
              "contextType": "variable",
              "element": "activity",
              "variable": "activity",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "CarePlan_Activity"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_act_det",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "activity",
                  "contextType": "variable",
                  "element": "detail",
                  "variable": "detail",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "CarePlan_ActivityDetail"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_act_det_data",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "detail",
                      "contextType": "variable",
                      "element": "kind",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "Task"
                        }
                      ]
                    },
                    {
                      "context": "detail",
                      "contextType": "variable",
                      "element": "status",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "scheduled"
                        }
                      ]
                    },
                    {
                      "context": "detail",
                      "contextType": "variable",
                      "element": "description",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "reasonText.value"
                        }
                      ]
                    },
                    {
                      "context": "detail",
                      "contextType": "variable",
                      "element": "code",
                      "transform": "cc",
                      "parameter": [
                        {
                          "valueString": "https://d-tree.org"
                        },
                        {
                          "valueId": "outcomeQuestionnaireId"
                        },
                        {
                          "valueId": "reasonDisplay"
                        }
                      ]
                    },
                    {
                      "context": "detail",
                      "contextType": "variable",
                      "element": "performer",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "carePlan.author"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_act_scheduled_period",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "detail",
                      "contextType": "variable",
                      "element": "scheduled",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueId": "schedulePeriod"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_create_task_id",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "variable": "taskId",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "string"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_set_task_id",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "taskId",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "uuid"
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_act_outcome_reference",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "activity",
                          "contextType": "variable",
                          "element": "outcomeReference",
                          "variable": "activityOutcomeRef",
                          "transform": "create",
                          "parameter": [
                            {
                              "valueString": "Reference"
                            }
                          ]
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_act_outcome_reference_ref",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "activityOutcomeRef",
                              "contextType": "variable",
                              "element": "reference",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "src"
                                },
                                {
                                  "valueString": "'Task/' + taskId.value"
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "name": "r_act_outcome_reference_display",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "activityOutcomeRef",
                              "contextType": "variable",
                              "element": "display",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "src"
                                },
                                {
                                  "valueString": "reasonDisplay.value"
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "name": "r_create_task_uuid",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "dependent": [
                            {
                              "name": "ExtractTracingTask",
                              "variable": [
                                "src",
                                "taskId",
                                "reasonCode",
                                "reasonDisplay",
                                "reasonText",
                                "schedulePeriod",
                                "hasPhone",
                                "outcomeQuestionnaireId",
                                "bundle",
                                "carePlan"
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "ExtractTracingTask",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "taskId",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "reasonCode",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "reasonDisplay",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "reasonText",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "activityScheduledPeriod",
          "type": "Period",
          "mode": "source"
        },
        {
          "name": "hasPhone",
          "type": "boolean",
          "mode": "source"
        },
        {
          "name": "outcomeQuestionnaireId",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        },
        {
          "name": "carePlan",
          "type": "Careplan",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_create_task",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "bundle",
              "contextType": "variable",
              "element": "entry",
              "variable": "entry"
            },
            {
              "context": "entry",
              "contextType": "variable",
              "element": "resource",
              "variable": "task",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "Task"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_task_data",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "status",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "ready"
                    }
                  ]
                },
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "intent",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "plan"
                    }
                  ]
                },
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "priority",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "routine"
                    }
                  ]
                },
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "authoredOn",
                  "variable": "current_date_time",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "now()"
                    }
                  ]
                },
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "lastModified",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueId": "current_date_time"
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_create_id",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "variable": "task_id",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "id"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_set_task_id_value",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "task_id",
                      "contextType": "variable",
                      "element": "value",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueId": "taskId"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_set_task_id",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "task",
                      "contextType": "variable",
                      "element": "id",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueId": "task_id"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_task_create_identifier",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "identifier",
                  "variable": "identifier",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Identifier"
                    }
                  ]
                },
                {
                  "context": "identifier",
                  "contextType": "variable",
                  "element": "use",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "official"
                    }
                  ]
                },
                {
                  "context": "identifier",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "uuid"
                }
              ]
            },
            {
              "name": "r_task_code",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "code",
                  "variable": "codeableConcept",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "CodeableConcept"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_task_code_text",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "codeableConcept",
                      "contextType": "variable",
                      "element": "text",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "Contact Tracing"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_task_code_coding",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "codeableConcept",
                      "contextType": "variable",
                      "element": "coding",
                      "variable": "coding",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Coding"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_task_code_coding_value",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "system",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "http://snomed.info/sct"
                            }
                          ]
                        },
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "code",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "225368008"
                            }
                          ]
                        },
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "display",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "Contact tracing (procedure)"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_task_tracing_meta",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "meta",
                  "variable": "meta",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Meta"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_task_meta_coding",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "meta",
                      "contextType": "variable",
                      "element": "tag",
                      "variable": "coding",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Coding"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_task_meta_coding_system",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "system",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "https://d-tree.org"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_task_meta_coding_phone",
                      "source": [
                        {
                          "context": "hasPhone",
                          "condition": "($this = true)"
                        }
                      ],
                      "target": [
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "code",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "phone-tracing"
                            }
                          ]
                        },
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "display",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "Phone Tracing"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_task_meta_coding_home",
                      "source": [
                        {
                          "context": "hasPhone",
                          "condition": "($this = false)"
                        }
                      ],
                      "target": [
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "code",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "home-tracing"
                            }
                          ]
                        },
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "display",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "Home Tracing"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_task_description",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "description",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "iif(hasPhone = true, 'HIV Contact Tracing via phone', 'HIV Contact Tracing via home visit')"
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_task_for",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "for",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "carePlan.subject"
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_task_scheduled_period",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "executionPeriod",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueId": "activityScheduledPeriod"
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_task_owner",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "owner",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "carePlan.author"
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_item_reason_for_removal_obs_value",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "reasonCode",
                  "variable": "codeableConcept",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "CodeableConcept"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_task_resonCode_text",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "codeableConcept",
                      "contextType": "variable",
                      "element": "text",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "reasonText.value"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_task_resonCode_coding",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "codeableConcept",
                      "contextType": "variable",
                      "element": "coding",
                      "variable": "coding",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Coding"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_task_resonCode_coding_value",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "system",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "https://d-tree.org"
                            }
                          ]
                        },
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "code",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "reasonCode.value"
                            }
                          ]
                        },
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "display",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "reasonDisplay.value"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_task_reason_reference",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "task",
                  "contextType": "variable",
                  "element": "reasonReference",
                  "variable": "taskReasonRef",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Reference"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_task_reason_reference_ref",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "taskReasonRef",
                      "contextType": "variable",
                      "element": "reference",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "'Questionnaire/' + outcomeQuestionnaireId.value"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_task_reason_reference_display",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "taskReasonRef",
                      "contextType": "variable",
                      "element": "display",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "reasonDisplay.value + ' outcome'"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "UpdateCurrentTracingTasks",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_tracing_item",
          "source": [
            {
              "context": "src",
              "element": "item",
              "variable": "tracingItem",
              "condition": "(linkId.startsWith('tracing-task') and (answer.count() > 0))"
            }
          ],
          "rule": [
            {
              "name": "r_tracing_task_evaluations",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "variable": "tracingTaskAnswer",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "tracingItem.answer.value"
                    }
                  ]
                },
                {
                  "variable": "indexOfSplitter",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "tracingTaskAnswer.indexOf(',')"
                    }
                  ]
                },
                {
                  "variable": "tracingTaskId",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "tracingTaskAnswer.substring(0, indexOfSplitter)"
                    }
                  ]
                },
                {
                  "variable": "taskStart",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "dateTime"
                    }
                  ]
                },
                {
                  "context": "taskStart",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "tracingTaskAnswer.substring(indexOfSplitter + 1)"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_tracing_task",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "bundle",
                      "contextType": "variable",
                      "element": "entry",
                      "variable": "entry"
                    },
                    {
                      "variable": "timeNow",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "now()"
                        }
                      ]
                    },
                    {
                      "context": "entry",
                      "contextType": "variable",
                      "element": "resource",
                      "variable": "task",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Task"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_tracing_task_id",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "task",
                          "contextType": "variable",
                          "element": "id",
                          "variable": "taskId",
                          "transform": "create",
                          "parameter": [
                            {
                              "valueString": "id"
                            }
                          ]
                        },
                        {
                          "context": "taskId",
                          "contextType": "variable",
                          "element": "value",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueId": "tracingTaskId"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_tracing_task_status",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "task",
                          "contextType": "variable",
                          "element": "status",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "iif(timeNow >= taskStart, 'completed', 'cancelled')"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_tracing_task_execution_period",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "task",
                          "contextType": "variable",
                          "element": "executionPeriod",
                          "variable": "taskPeriod",
                          "transform": "create",
                          "parameter": [
                            {
                              "valueString": "Period"
                            }
                          ]
                        },
                        {
                          "context": "taskPeriod",
                          "contextType": "variable",
                          "element": "start",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueId": "taskStart"
                            }
                          ]
                        },
                        {
                          "context": "taskPeriod",
                          "contextType": "variable",
                          "element": "end",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "iif(timeNow >= taskStart, timeNow)"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "AssignAppointmentStart",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "dateOfNextAppointString",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "appointment",
          "type": "Appointment",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_start_instant_value",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "appointment",
              "contextType": "variable",
              "element": "start",
              "variable": "startInstant",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "instant"
                }
              ]
            },
            {
              "context": "startInstant",
              "contextType": "variable",
              "element": "value",
              "transform": "evaluate",
              "parameter": [
                {
                  "valueId": "src"
                },
                {
                  "valueString": "dateOfNextAppointString + 'T00:00:00.000Z'"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "AppointmentFulfilled",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "appointment",
          "type": "Appointment",
          "mode": "target"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_fulfill_appointment_if_early",
          "source": [
            {
              "context": "src",
              "condition": "(appointment.start.exists())"
            }
          ],
          "target": [
            {
              "variable": "startString",
              "transform": "evaluate",
              "parameter": [
                {
                  "valueId": "appointment"
                },
                {
                  "valueString": "$this.start.toString()"
                }
              ]
            },
            {
              "variable": "separatorIndex",
              "transform": "evaluate",
              "parameter": [
                {
                  "valueId": "src"
                },
                {
                  "valueString": "startString.indexOf('T')"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_check_appointment_start_date",
              "source": [
                {
                  "context": "src",
                  "condition": "(separatorIndex != ( - 1))"
                }
              ],
              "target": [
                {
                  "variable": "startDateStringPart",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "startString.substring(0, separatorIndex)"
                    }
                  ]
                },
                {
                  "variable": "appointmentDate",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "date"
                    }
                  ]
                },
                {
                  "context": "appointmentDate",
                  "contextType": "variable",
                  "element": "value",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueId": "startDateStringPart"
                    }
                  ]
                },
                {
                  "variable": "isTodayEarly",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "today() <= appointmentDate"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_appoinment_fulfilled",
                  "source": [
                    {
                      "context": "src",
                      "condition": "(isTodayEarly = true)"
                    }
                  ],
                  "target": [
                    {
                      "context": "bundle",
                      "contextType": "variable",
                      "element": "entry",
                      "variable": "bundleEntry"
                    },
                    {
                      "context": "bundleEntry",
                      "contextType": "variable",
                      "element": "resource",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueId": "appointment"
                        }
                      ]
                    },
                    {
                      "context": "appointment",
                      "contextType": "variable",
                      "element": "status",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "fulfilled"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "ExtractARTNewAppointmentWithStart",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "dateOfNextAppointString",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_eval_appointment_create_assign",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "variable": "proceedToCreateRefillAppointment",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "context": "proceedToCreateRefillAppointment",
              "contextType": "variable",
              "element": "value",
              "transform": "copy",
              "parameter": [
                {
                  "valueString": "yes"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_contained_bundle",
              "source": [
                {
                  "context": "src",
                  "element": "contained",
                  "listMode": "first",
                  "variable": "contained",
                  "condition": "($this.ofType(Bundle).exists())"
                }
              ],
              "rule": [
                {
                  "name": "r_check_appointment_valid",
                  "source": [
                    {
                      "context": "contained"
                    }
                  ],
                  "target": [
                    {
                      "variable": "hasValidAppointment",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "contained"
                        },
                        {
                          "valueString": "$this.entry.resource.ofType(Appointment).exists()"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_appointment_to_set_next_date",
                      "source": [
                        {
                          "context": "contained",
                          "element": "entry",
                          "variable": "appointmentEntry",
                          "condition": "((hasValidAppointment = true) and ($this.resource is Appointment))"
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_check_appointment_fulfilled",
                          "source": [
                            {
                              "context": "appointmentEntry",
                              "variable": "maybeFulfilledApEntry",
                              "condition": "($this.resource.start.exists())"
                            }
                          ],
                          "target": [
                            {
                              "variable": "toBeFulfilledAppointment",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "maybeFulfilledApEntry"
                                },
                                {
                                  "valueString": "$this.resource"
                                }
                              ]
                            }
                          ],
                          "dependent": [
                            {
                              "name": "AppointmentFulfilled",
                              "variable": [
                                "src",
                                "toBeFulfilledAppointment",
                                "bundle"
                              ]
                            }
                          ]
                        },
                        {
                          "name": "r_valid_appointment_assign_start_instant",
                          "source": [
                            {
                              "context": "appointmentEntry",
                              "variable": "appointment",
                              "condition": "($this.resource.start.empty())"
                            }
                          ],
                          "target": [
                            {
                              "context": "proceedToCreateRefillAppointment",
                              "contextType": "variable",
                              "element": "value",
                              "transform": "copy",
                              "parameter": [
                                {
                                  "valueString": "no"
                                }
                              ]
                            },
                            {
                              "context": "bundle",
                              "contextType": "variable",
                              "element": "entry",
                              "variable": "resultBundleEntry"
                            },
                            {
                              "context": "resultBundleEntry",
                              "contextType": "variable",
                              "element": "resource",
                              "variable": "appointment",
                              "transform": "evaluate",
                              "parameter": [
                                {
                                  "valueId": "appointmentEntry"
                                },
                                {
                                  "valueString": "$this.resource"
                                }
                              ]
                            }
                          ],
                          "dependent": [
                            {
                              "name": "AssignAppointmentStart",
                              "variable": [
                                "src",
                                "dateOfNextAppointString",
                                "appointment"
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_new_appointments_check_patient_category",
              "source": [
                {
                  "context": "src",
                  "condition": "(proceedToCreateRefillAppointment.value = 'yes')"
                }
              ],
              "target": [
                {
                  "variable": "patientCategory",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "$this.item.where(linkId = 'patient-category').answer.value.code"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_create_refill_appointment",
                  "source": [
                    {
                      "context": "src",
                      "condition": "((patientCategory = 'newly-diagnosed-client') or (patientCategory = 'client-already-on-art'))"
                    }
                  ],
                  "dependent": [
                    {
                      "name": "NewRefillAppointment",
                      "variable": [
                        "src",
                        "dateOfNextAppointString",
                        "bundle"
                      ]
                    }
                  ]
                },
                {
                  "name": "r_eval_infant_new_appointment",
                  "source": [
                    {
                      "context": "src",
                      "condition": "(patientCategory = 'exposed-infant')"
                    }
                  ],
                  "target": [
                    {
                      "variable": "birthDate",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "$this.item.where(linkId = 'patient-birth-date').answer.value"
                        }
                      ]
                    },
                    {
                      "variable": "is6weeks",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "birthDate = (today() - '6 weeks'.toQuantity())"
                        }
                      ]
                    },
                    {
                      "variable": "is1year",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "birthDate = (today() - '365 days'.toQuantity())"
                        }
                      ]
                    },
                    {
                      "variable": "is2years",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "birthDate = (today() - '730 days'.toQuantity())"
                        }
                      ]
                    },
                    {
                      "variable": "isOlderThan2years",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "birthDate > (today() - '730 days'.toQuantity())"
                        }
                      ]
                    },
                    {
                      "variable": "requiresMilestoneScreening",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "$this.item.where(linkId = 'conduct-milestone-hiv-screening-test').answer.value.exists() and ($this.item.where(linkId = 'conduct-milestone-hiv-screening-test').answer.value = 'true')"
                        }
                      ]
                    },
                    {
                      "variable": "needsAppointmentForMilestone",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "is6weeks or is1year or is2years or (isOlderThan2years and requiresMilestoneScreening)"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_new_milestone_visit_appointment",
                      "source": [
                        {
                          "context": "src",
                          "condition": "(needsAppointmentForMilestone = true)"
                        }
                      ],
                      "dependent": [
                        {
                          "name": "ExposedInfantMilestoneHivTestAppointment",
                          "variable": [
                            "src",
                            "dateOfNextAppointString",
                            "bundle"
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_new_infant_routine_visit",
                      "source": [
                        {
                          "context": "src",
                          "condition": "(needsAppointmentForMilestone = false)"
                        }
                      ],
                      "dependent": [
                        {
                          "name": "ExposedInfantRoutineVisitAppointment",
                          "variable": [
                            "src",
                            "dateOfNextAppointString",
                            "bundle"
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "NewRefillAppointment",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "dateOfNextAppointString",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_refill_appointment",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "variable": "reasonText",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "context": "reasonText",
              "contextType": "variable",
              "element": "value",
              "transform": "copy",
              "parameter": [
                {
                  "valueString": "Refill"
                }
              ]
            },
            {
              "variable": "reasonCode",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "context": "reasonCode",
              "contextType": "variable",
              "element": "value",
              "transform": "copy",
              "parameter": [
                {
                  "valueString": "Refill"
                }
              ]
            },
            {
              "variable": "reasonDescription",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "context": "reasonDescription",
              "contextType": "variable",
              "element": "value",
              "transform": "copy",
              "parameter": [
                {
                  "valueString": "Refill"
                }
              ]
            }
          ],
          "dependent": [
            {
              "name": "NewAppointment",
              "variable": [
                "src",
                "dateOfNextAppointString",
                "reasonCode",
                "reasonDescription",
                "reasonText",
                "bundle"
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "ExposedInfantMilestoneHivTestAppointment",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireReponse",
          "mode": "source"
        },
        {
          "name": "dateOfNextAppointString",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_milestone_hiv_visit_appointment",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "variable": "reasonText",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "context": "reasonText",
              "contextType": "variable",
              "element": "value",
              "transform": "copy",
              "parameter": [
                {
                  "valueString": "Milestone HIV Test"
                }
              ]
            },
            {
              "variable": "reasonCode",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "context": "reasonCode",
              "contextType": "variable",
              "element": "value",
              "transform": "copy",
              "parameter": [
                {
                  "valueString": "Milestone"
                }
              ]
            },
            {
              "variable": "reasonDescription",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "context": "reasonDescription",
              "contextType": "variable",
              "element": "value",
              "transform": "copy",
              "parameter": [
                {
                  "valueString": "Milestone HIV Test"
                }
              ]
            }
          ],
          "dependent": [
            {
              "name": "NewAppointment",
              "variable": [
                "src",
                "dateOfNextAppointString",
                "reasonCode",
                "reasonDescription",
                "reasonText",
                "bundle"
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "ExposedInfantRoutineVisitAppointment",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "dateOfNextAppointString",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_routine_visit_appointment",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "variable": "reasonText",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "context": "reasonText",
              "contextType": "variable",
              "element": "value",
              "transform": "copy",
              "parameter": [
                {
                  "valueString": "Routine Visit"
                }
              ]
            },
            {
              "variable": "reasonCode",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "context": "reasonCode",
              "contextType": "variable",
              "element": "value",
              "transform": "copy",
              "parameter": [
                {
                  "valueString": "Routine"
                }
              ]
            },
            {
              "variable": "reasonDescription",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "string"
                }
              ]
            },
            {
              "context": "reasonDescription",
              "contextType": "variable",
              "element": "value",
              "transform": "copy",
              "parameter": [
                {
                  "valueString": "Routine Visit"
                }
              ]
            }
          ],
          "dependent": [
            {
              "name": "NewAppointment",
              "variable": [
                "src",
                "dateOfNextAppointString",
                "reasonCode",
                "reasonDescription",
                "reasonText",
                "bundle"
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "NewAppointment",
      "typeMode": "none",
      "input": [
        {
          "name": "src",
          "type": "QuestionnaireResponse",
          "mode": "source"
        },
        {
          "name": "dateOfNextAppointString",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "reasonCode",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "reasonDescription",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "reasonText",
          "type": "string",
          "mode": "source"
        },
        {
          "name": "bundle",
          "type": "Bundle",
          "mode": "target"
        }
      ],
      "rule": [
        {
          "name": "r_create_new_appointment",
          "source": [
            {
              "context": "src"
            }
          ],
          "target": [
            {
              "context": "bundle",
              "contextType": "variable",
              "element": "entry",
              "variable": "entry"
            },
            {
              "context": "entry",
              "contextType": "variable",
              "element": "resource",
              "variable": "appointment",
              "transform": "create",
              "parameter": [
                {
                  "valueString": "Appointment"
                }
              ]
            }
          ],
          "rule": [
            {
              "name": "r_appointment_default",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "appointment",
                  "contextType": "variable",
                  "element": "id",
                  "transform": "uuid"
                },
                {
                  "context": "appointment",
                  "contextType": "variable",
                  "element": "status",
                  "transform": "copy",
                  "parameter": [
                    {
                      "valueString": "booked"
                    }
                  ]
                },
                {
                  "context": "appointment",
                  "contextType": "variable",
                  "element": "created",
                  "transform": "evaluate",
                  "parameter": [
                    {
                      "valueId": "src"
                    },
                    {
                      "valueString": "now()"
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_appointment_service_category",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "appointment",
                  "contextType": "variable",
                  "element": "serviceCategory",
                  "variable": "codeableConcept",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "CodeableConcept"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_appointment_code_text",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "codeableConcept",
                      "contextType": "variable",
                      "element": "text",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "HIV-AIDS program"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_appointment_code_coding",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "codeableConcept",
                      "contextType": "variable",
                      "element": "coding",
                      "variable": "coding",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Coding"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_appointment_code_coding_value",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "system",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "http://terminology.hl7.org/CodeSystem/v3-ActCode"
                            }
                          ]
                        },
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "code",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "HIVAIDS"
                            }
                          ]
                        },
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "display",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "HIV-AIDS program"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_appointment_type",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "appointment",
                  "contextType": "variable",
                  "element": "appointmentType",
                  "variable": "codeableConcept",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "CodeableConcept"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_appointment_code_text",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "codeableConcept",
                      "contextType": "variable",
                      "element": "text",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "Routine appointment"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_appointment_code_coding",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "codeableConcept",
                      "contextType": "variable",
                      "element": "coding",
                      "variable": "coding",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Coding"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_appointment_code_coding_value",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "system",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "http://terminology.hl7.org/CodeSystem/v2-0276"
                            }
                          ]
                        },
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "code",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "ROUTINE"
                            }
                          ]
                        },
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "display",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "Routine appointment"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_appointment_code",
              "source": [
                {
                  "context": "src"
                }
              ],
              "target": [
                {
                  "context": "appointment",
                  "contextType": "variable",
                  "element": "reasonCode",
                  "variable": "codeableConcept",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "CodeableConcept"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_appointment_code_text",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "codeableConcept",
                      "contextType": "variable",
                      "element": "text",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "reasonText"
                        },
                        {
                          "valueString": "$this.value"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_appointment_code_coding",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "codeableConcept",
                      "contextType": "variable",
                      "element": "coding",
                      "variable": "coding",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Coding"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_appointment_code_coding_value",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "system",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "https://d-tree.org"
                            }
                          ]
                        },
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "code",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "reasonCode"
                            },
                            {
                              "valueString": "$this.value"
                            }
                          ]
                        },
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "display",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "reasonDescription"
                            },
                            {
                              "valueString": "$this.value"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_appointment_start_instant",
              "source": [
                {
                  "context": "src"
                }
              ],
              "dependent": [
                {
                  "name": "AssignAppointmentStart",
                  "variable": [
                    "src",
                    "dateOfNextAppointString",
                    "appointment"
                  ]
                }
              ]
            },
            {
              "name": "r_ppointment_part_patient_component",
              "source": [
                {
                  "context": "src",
                  "element": "item",
                  "listMode": "first",
                  "condition": "(linkId = 'patient-id')"
                }
              ],
              "target": [
                {
                  "context": "appointment",
                  "contextType": "variable",
                  "element": "participant",
                  "variable": "partComp",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Appointment_Participant"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_appointment_comp_one_liners",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "partComp",
                      "contextType": "variable",
                      "element": "required",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "required"
                        }
                      ]
                    },
                    {
                      "context": "partComp",
                      "contextType": "variable",
                      "element": "status",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "accepted"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_appointment_participant_code",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "partComp",
                      "contextType": "variable",
                      "element": "type",
                      "variable": "codeableConcept",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "CodeableConcept"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_appointment_code_text",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "codeableConcept",
                          "contextType": "variable",
                          "element": "text",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "Subject"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_appointment_participant_code_coding",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "codeableConcept",
                          "contextType": "variable",
                          "element": "coding",
                          "variable": "coding",
                          "transform": "create",
                          "parameter": [
                            {
                              "valueString": "Coding"
                            }
                          ]
                        }
                      ],
                      "rule": [
                        {
                          "name": "r_appointment_code_coding_value",
                          "source": [
                            {
                              "context": "src"
                            }
                          ],
                          "target": [
                            {
                              "context": "coding",
                              "contextType": "variable",
                              "element": "system",
                              "transform": "copy",
                              "parameter": [
                                {
                                  "valueString": "http://terminology.hl7.org/CodeSystem/v3-ParticipationType"
                                }
                              ]
                            },
                            {
                              "context": "coding",
                              "contextType": "variable",
                              "element": "code",
                              "transform": "copy",
                              "parameter": [
                                {
                                  "valueString": "SBJ"
                                }
                              ]
                            },
                            {
                              "context": "coding",
                              "contextType": "variable",
                              "element": "display",
                              "transform": "copy",
                              "parameter": [
                                {
                                  "valueString": "subject"
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_ppointment_part_actor",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "partComp",
                      "contextType": "variable",
                      "element": "actor",
                      "variable": "encOwner",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Reference"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_ppointment_part_reference",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "encOwner",
                          "contextType": "variable",
                          "element": "reference",
                          "transform": "evaluate",
                          "parameter": [
                            {
                              "valueId": "src"
                            },
                            {
                              "valueString": "'Patient/' + $this.item.where(linkId = 'patient-id').answer.value"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "name": "r_appointment_part_performer",
              "source": [
                {
                  "context": "src",
                  "element": "item",
                  "listMode": "first",
                  "condition": "(linkId = 'practitioner-id')"
                }
              ],
              "target": [
                {
                  "context": "appointment",
                  "contextType": "variable",
                  "element": "participant",
                  "variable": "performerComp",
                  "transform": "create",
                  "parameter": [
                    {
                      "valueString": "Appointment_Participant"
                    }
                  ]
                }
              ],
              "rule": [
                {
                  "name": "r_appointment_part_one_liners",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "performerComp",
                      "contextType": "variable",
                      "element": "required",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "required"
                        }
                      ]
                    },
                    {
                      "context": "performerComp",
                      "contextType": "variable",
                      "element": "status",
                      "transform": "copy",
                      "parameter": [
                        {
                          "valueString": "accepted"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_appointment_performer_type",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "performerComp",
                      "contextType": "variable",
                      "element": "type",
                      "variable": "codeableConcept",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "CodeableConcept"
                        }
                      ]
                    }
                  ],
                  "rule": [
                    {
                      "name": "r_appointment_part_performer_type_text",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "codeableConcept",
                          "contextType": "variable",
                          "element": "text",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "Performer"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "name": "r_appointment_part_performer_type_coding",
                      "source": [
                        {
                          "context": "src"
                        }
                      ],
                      "target": [
                        {
                          "context": "codeableConcept",
                          "contextType": "variable",
                          "element": "coding",
                          "variable": "coding",
                          "transform": "create",
                          "parameter": [
                            {
                              "valueString": "Coding"
                            }
                          ]
                        },
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "system",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "http://terminology.hl7.org/CodeSystem/v3-ParticipationType"
                            }
                          ]
                        },
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "code",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "PRF"
                            }
                          ]
                        },
                        {
                          "context": "coding",
                          "contextType": "variable",
                          "element": "display",
                          "transform": "copy",
                          "parameter": [
                            {
                              "valueString": "Performer"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "name": "r_appointment_actor_performer",
                  "source": [
                    {
                      "context": "src"
                    }
                  ],
                  "target": [
                    {
                      "context": "performerComp",
                      "contextType": "variable",
                      "element": "actor",
                      "variable": "performer",
                      "transform": "create",
                      "parameter": [
                        {
                          "valueString": "Reference"
                        }
                      ]
                    },
                    {
                      "context": "performer",
                      "contextType": "variable",
                      "element": "reference",
                      "transform": "evaluate",
                      "parameter": [
                        {
                          "valueId": "src"
                        },
                        {
                          "valueString": "'Practitioner/' + $this.item.where(linkId = 'practitioner-id').answer.value"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}