map "http://fhir.mpower-social.com:7070/fhir/StructureMap/6484" = 'mPower Household Visit'

uses "http://hl7.org/fhir/StructureDefinition/QuestionnaireReponse" as source
uses "http://hl7.org/fhir/StructureDefinition/Bundle" as target
uses "http://hl7.org/fhir/StructureDefinition/Group" as target
uses "http://hl7.org/fhir/StructureDefinition/Encounter" as target

group mPowerHouseholdVisit(source src : QuestionnaireResponse, target bundle: Bundle) {
    src -> bundle.id = uuid() "rule_bundle_id";
    src -> bundle.type = 'collection' "rule_bundle_type";
    src -> bundle.entry as entry, entry.resource = create('Group') as group then
        UpdateGroup(src, group, bundle) "rule_bundle_entries";
}

group UpdateGroup(source src : QuestionnaireResponse, target group : Group, target bundle: Bundle) {
    src.item as item where(linkId = "210afefc-3e4f-4489-86af-587ada65e06c" and answer.value.exists()) then {
       src -> group.id = create("id") as group_id then {
           src->group_id.value = evaluate(item, $this.answer.value) "r_item_group_id_value";
       } "r_item_group_id";

       src -> group.name = evaluate(src, $this.item.where(linkId = 'aaafd263-5e5b-4b78-bbc6-e01be0eb72ec').answer.value) "rule_group_name";

       src -> group.characteristic = create('Group_Characteristic') as includeFamily then {
           src -> includeFamily.exclude = false "rule_exclude_group_false";
       } "rule_group_char";

       src -> group.characteristic = create('Group_Characteristic') as familyCharacteristic then {
           src -> familyCharacteristic.code = create('CodeableConcept') as familyCharacteristicCode then{
               src -> familyCharacteristicCode.coding = c("https://www.mpower-social.com/", "active") as coding then {
               src -> coding.display = 'Active' "r_cp_cod_disp_v";
               } "r_grp_vcode";
           } "rule_group_char_code";
       } "rule_group_char";

       src.item as familyHome where(linkId='30c16801-3742-4631-888e-0732bd748d77') -> group.characteristic = create ('Group_Characteristic') as groupCharacteristic then {
            familyHome -> groupCharacteristic.code = create('CodeableConcept') as hhSerial then{
                src -> hhSerial.coding = c("http://www.mpower-social.com/codes", "hh_serial") as coding then {
                src -> coding.display = 'HH Serial' "r_cp_cod_disp_v";
                } "r_grp_hh_serial";
                src -> hhSerial.text = evaluate(familyHome, $this.answer.value) "r_vcc_hh_serial";
            } "r_cp_cc_coding_v";
            familyHome -> groupCharacteristic.exclude = false "r_cp_cc_exclude_v";
       } "r_group_char_hh_serial";

       src.item as familyPhone where(linkId='3193ad83-4864-419f-851f-4f5d82948bb8') -> group.characteristic = create ('Group_Characteristic') as groupCharacteristic then {
            familyPhone -> groupCharacteristic.code = create('CodeableConcept') as hhPhone then{
                src -> hhPhone.coding = c("http://www.mpower-social.com/codes", "hh_phone") as coding then {
                src -> coding.display = 'Household Mobile' "r_cp_cod_disp_hh_phone";
                } "r_grp_hh_phone_code";
                src -> hhPhone.text = evaluate(familyPhone, $this.answer.value) "r_vcc_hh_phone";
            } "r_cp_cc_coding_hh_phone";
            familyPhone -> groupCharacteristic.exclude = false "r_cp_cc_exclude_hh_phone";
       } "r_group_char_hh_phone";

       src.item as familyType where(linkId='603e8034-26d0-420a-86f7-577ab9c9bf9c') -> group.characteristic = create ('Group_Characteristic') as groupCharacteristic then {
            familyType -> groupCharacteristic.code = create('CodeableConcept') as hhTypeCode then{
                src -> hhTypeCode.coding = c("http://www.mpower-social.com/codes", "hh_type") as coding then {
                src -> coding.display = 'Household Type' "r_cp_cod_disp_hh_type";
                } "r_grp_hh_type_code";
                src -> hhTypeCode.text = evaluate(familyType, $this.answer.value.code) "r_vcc_hh_type";
            } "r_cp_cc_coding_hh_type";
            familyType -> groupCharacteristic.exclude = false "r_cp_cc_exclude_hh_type";
       } "r_group_char_hh_type";

       src.item as familyMember where(linkId='29b9289c-be48-49c0-81e4-e93cde1c33c2') -> group.characteristic = create ('Group_Characteristic') as groupCharacteristic then {
            familyMember -> groupCharacteristic.code = create('CodeableConcept') as memberCount then{
                src -> memberCount.coding = c("http://www.mpower-social.com/codes", "hh_member_count") as coding then {
                src -> coding.display = 'Household Memeber Count' "r_cp_cod_disp_hh_member_count";
                } "r_grp_hh_member_count";
                src -> memberCount.text = evaluate(familyMember, $this.answer.value) "r_vcc_hh_member_count";
            } "r_cp_cc_coding_hh_member_count";
            familyMember -> groupCharacteristic.exclude = false "r_cp_cc_exclude_hh_member_count";
       } "r_group_char_hh_member_count";

       src.item as headOccupation where(linkId='023ca3f7-5591-46c6-8002-2fb31415c069') -> group.characteristic = create ('Group_Characteristic') as groupCharacteristic then {
            headOccupation -> groupCharacteristic.code = create('CodeableConcept') as occupation then {
                src -> occupation.coding = c("http://snomed.info/sct", "184104002") as coding then {
                src -> coding.display = 'Household Head Occupation' "r_cp_cod_disp_hh_head_occ";
                } "r_grp_hh_head_occ";
                src -> occupation.text = evaluate(headOccupation, $this.answer.value.code) "r_vcc_hh_head_occ";
            } "r_cp_cc_coding_hh_head_occ";
            headOccupation -> groupCharacteristic.exclude = false "r_cp_cc_exclude_hh_head_occ";
       } "r_group_char_hh_head_occ";

       src.item as hhIncome where(linkId='5d0d2f3c-ca4b-4752-831b-0d604c6b0d98') -> group.characteristic = create ('Group_Characteristic') as groupCharacteristic then {
            hhIncome -> groupCharacteristic.code = create('CodeableConcept') as income then {
                src -> income.coding = c("http://snomed.info/sct", "224167002") as coding then {
                src -> coding.display = 'Household Income Details' "r_cp_cod_disp_hh_income";
                } "r_grp_hh_income";
                src -> income.text = evaluate(hhIncome, $this.answer.value.code) "r_vcc_hh_income";
            } "r_cp_cc_coding_hh_income";
            hhIncome -> groupCharacteristic.exclude = false "r_cp_cc_exclude_hh_income";
       } "r_group_char_hh_income";

       src.item as hhLatrine where(linkId='90331830-e4f0-4cb7-8a15-3e330ebfcfc0') -> group.characteristic = create ('Group_Characteristic') as groupCharacteristic then {
            hhLatrine -> groupCharacteristic.code = create('CodeableConcept') as latrine then {
                src -> latrine.coding = c("http://www.mpower-social.com/codes", "hh_has_latrine") as coding then {
                src -> coding.display = 'Household Has Latrine' "r_cp_cod_disp_hh_latrine";
                } "r_grp_hh_latrine";
                src -> latrine.text = evaluate(hhLatrine, $this.answer.value.code) "r_vcc_hh_latrine";
            } "r_cp_cc_coding_hh_latrine";
            hhLatrine -> groupCharacteristic.exclude = false "r_cp_cc_exclude_hh_latrine";
       } "r_group_char_hh_latrine";

       src.item as hhFloorMaterial where(linkId='bc1d24fc-3254-4fac-f210-0b4f0c159dc9') -> group.characteristic = create ('Group_Characteristic') as groupCharacteristic then {
            hhFloorMaterial -> groupCharacteristic.code = create('CodeableConcept') as floor then {
                src -> floor.coding = c("http://www.mpower-social.com/codes", "hh_floor_material") as coding then {
                src -> coding.display = 'Household Floor Material' "r_cp_cod_disp_hh_floor";
                } "r_grp_hh_floor";
                src -> floor.text = evaluate(hhFloorMaterial, $this.answer.value.code) "r_vcc_hh_floor";
            } "r_cp_cc_coding_hh_floor";
            hhFloorMaterial -> groupCharacteristic.exclude = false "r_cp_cc_exclude_hh_floor";
       } "r_group_char_hh_floor";

       src.item as hhWallMaterial where(linkId='7e1b63bb-c609-498f-d3f7-5b47c792acb1') -> group.characteristic = create ('Group_Characteristic') as groupCharacteristic then {
            hhWallMaterial -> groupCharacteristic.code = create('CodeableConcept') as wall then {
                src -> wall.coding = c("http://www.mpower-social.com/codes", "hh_wall_material") as coding then {
                src -> coding.display = 'Household Wall Material' "r_cp_cod_disp_hh_wall";
                } "r_grp_hh_wall";
                src -> wall.text = evaluate(hhWallMaterial, $this.answer.value.code) "r_vcc_hh_wall";
            } "r_cp_cc_coding_hh_wall";
            hhWallMaterial -> groupCharacteristic.exclude = false "r_cp_cc_exclude_hh_wall";
       } "r_group_char_hh_wall";

       src.item as hhRoofMaterial where(linkId='b513eafb-777d-4908-83b5-0d4836e061c6') -> group.characteristic = create ('Group_Characteristic') as groupCharacteristic then {
            hhRoofMaterial -> groupCharacteristic.code = create('CodeableConcept') as roof then {
                src -> roof.coding = c("http://www.mpower-social.com/codes", "hh_roof_material") as coding then {
                src -> coding.display = 'Household Roof Material' "r_cp_cod_disp_hh_roof";
                } "r_grp_hh_roof";
                src -> roof.text = evaluate(hhRoofMaterial, $this.answer.value.code) "r_vcc_hh_roof";
            } "r_cp_cc_coding_hh_roof";
            hhRoofMaterial -> groupCharacteristic.exclude = false "r_cp_cc_exclude_hh_roof";
       } "r_group_char_hh_roof";

       src.item as hhHomesteadLand where(linkId='859563b7-7509-4756-89c1-1e1286d12955') -> group.characteristic = create ('Group_Characteristic') as groupCharacteristic then {
            hhHomesteadLand -> groupCharacteristic.code = create('CodeableConcept') as homesteadLand then {
                src -> homesteadLand.coding = c("http://www.mpower-social.com/codes", "hh_homestead_land") as coding then {
                src -> coding.display = 'Household Homestead Land' "r_cp_cod_disp_hh_homestead_land";
                } "r_grp_hh_homestead_land";
                src -> homesteadLand.text = evaluate(hhHomesteadLand, $this.answer.value) "r_vcc_hh_homestead_land";
            } "r_cp_cc_coding_hh_homestead_land";
            hhHomesteadLand -> groupCharacteristic.exclude = false "r_cp_cc_exclude_hh_homestead_land";
       } "r_group_char_hh_homestead_land";

       src.item as hhCultivableLand where(linkId='462d5637-ce8f-4a45-9c63-185d3816bb94') -> group.characteristic = create ('Group_Characteristic') as groupCharacteristic then {
            hhCultivableLand -> groupCharacteristic.code = create('CodeableConcept') as cultivableLand then {
                src -> cultivableLand.coding = c("http://www.mpower-social.com/codes", "hh_cultivable_land") as coding then {
                src -> coding.display = 'Household Cultivable Land' "r_cp_cod_disp_hh_cultivable_land";
                } "r_grp_hh_cultivable_land";
                src -> cultivableLand.text = evaluate(hhCultivableLand, $this.answer.value) "r_vcc_hh_cultivable_land";
            } "r_cp_cc_coding_hh_cultivable_land";
            hhCultivableLand -> groupCharacteristic.exclude = false "r_cp_cc_exclude_hh_cultivable_land";
       } "r_group_char_hh_cultivable_land";

       src.item where(linkId ='018e238d-cdaa-484e-890c-e2745878ba72' and answer.value.code = 'yes') then {
           src then ExtractObservation(src, group, bundle) "rule_encounter_reference";
       } "r_group_extract_obs";
    } "r_extract_group_id_and_update";
}

group ExtractObservation(source src : QuestionnaireResponse, target group : Group, target bundle: Bundle) {
    src.item as corona_members where(linkId ='9e95c28a-c75c-4f26-f988-639bb05e36d5' and answer.value.exists()) then {
        src -> bundle.entry as entry, entry.resource = create('Observation') as obs then {
            src -> obs.id = uuid() "r_obs_id";
            src -> obs.status = 'final' "r_obs_status";
            src -> obs.category = cc('http://terminology.hl7.org/CodeSystem/observation-category','vital-signs', 'Vital Signs') "r_obs_category_1";
            src -> obs.code = create('CodeableConcept') as concept then {
                src -> concept.coding = c("http://snomed.info/sct", "840539006") as coding then {
                    src -> coding.display = 'COVID-19' "r_cp_cod_disp";
                } "r_cp_cc_cod";
            } "r_obs_code";
            src -> obs.subject = create('Reference') as ref then {
                src -> ref.reference = evaluate(src, 'Group/' + group.id) "rule_group_ref";
            } "r_obs_ref";
            src -> obs.effective = evaluate(src, now()) "r_effective_current_date_time";
            src -> obs.value = evaluate(corona_members, answer.value.count()) "r_obs_value";
        } "r_obs";
    } "check_and_extract_obs";
}