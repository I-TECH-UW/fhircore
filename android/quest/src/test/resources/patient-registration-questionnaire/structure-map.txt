map "https://fhir.labs.smartregister.org/fhir/StructureMap/8f7828f5-3910-4bfc-94a9-a0daagt51422" = "Urine test"

uses "http://hl7.org/fhir/StructureDefinition/QuestionnaireReponse" as source
uses "http://hl7.org/fhir/StructureDefinition/Bundle" as target

group ANCUrineTest(source src : QuestionnaireResponse, target bundle: Bundle) {
    src -> evaluate(src, $this.subject) as refPatient then
        ExtractEncounter(src, bundle, refPatient) "r_bundle_entries";
}

group ExtractEncounter(source src : QuestionnaireResponse, target bundle: Bundle) {
        src.item where (linkId = 'ac979068-1f73-4d1a-c03e-1bfb504c8c54' and answer.valueCoding.exists() and answer.valueCoding.code = 'no') then {
                src -> bundle.entry as entry, entry.resource = create('Encounter') as encounter then {
                       src -> encounter.status = answerValue "r_en_st";

                }"r_bundle";
    } "r_en";
}

