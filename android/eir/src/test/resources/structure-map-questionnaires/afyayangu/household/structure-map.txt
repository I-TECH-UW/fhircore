map "https://fhir.labs.smartregister.org/fhir/StructureMap/5667cfbd-13c4-4111-b952-7cee58bdb9d5" = 'afya yangu Family Registration'

uses "http://hl7.org/fhir/StructureDefinition/QuestionnaireReponse" as source
uses "http://hl7.org/fhir/StructureDefinition/Bundle" as target
uses "http://hl7.org/fhir/StructureDefinition/Group" as target

group eCBISFamilyRegistration(source src : QuestionnaireResponse, target bundle: Bundle) {
    src -> bundle.type = 'collection' "rule_bundle_type";
    src -> bundle.entry as entry, entry.resource = create('Group') as group then
        ExtractGroup(src, group) "rule_bundle_entries";
}

group ExtractGroup(source src : QuestionnaireResponse, target group : Group) {
       src -> group.id = uuid() "rule_group_id_generation";
       src -> group.name = evaluate(src, $this.item.where(linkId = 'abb75057-f186-40bb-ddaf-da72043f5dae').answer.value) "rule_group_name";

       src -> group.identifier = create('Identifier') as groupIdentifierHouseholdId then {
         src -> groupIdentifierHouseholdId.value = evaluate(src, $this.item.where(linkId = 'ce49bde4-6ef9-423e-c747-efab250cd770').answer.value)
         "rule_group_identifier_national_id_value";
         src -> groupIdentifierHouseholdId.use = "official" "rule_group_identifier_national_id_use";
       } "rule_group_identifier_national_id";

       src -> group.identifier = create('Identifier') as groupIdentifier then {
          src -> groupIdentifier.value = uuid() "rule_group_identifier_value";
          src -> groupIdentifier.use = "secondary" "rule_group_identifier_use";
       } "rule_group_identifier";

       src -> group.active = true "r_grp_status_data";
       src -> group.type = 'person' "r_grp_type_data";
       src -> group.code = create('CodeableConcept') as concept then ExtractTimingCode(src, concept) "r_grp_code_data";
}

group ExtractFamilyCode(source src : Group, target concept: CodeableConcept){
    src -> concept.coding = c("https://www.snomed.org", "35359004") as coding then {
        src -> coding.display = 'Family' "r_cp_cod_disp";
    } "r_cp_cc_cod";
}